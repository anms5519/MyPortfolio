<!DOCTYPE html>
<html lang="en" class="theme-dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ã‰lite CGPA Analyzer Suite</title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --font-main: 'Lexend', sans-serif;
                --transition-speed: 0.3s;
                --border-radius-lg: 16px;
                --border-radius-md: 10px;
                --border-radius-sm: 6px;
                --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.1);
                --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.15);
                --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.2);
            }
            .theme-light {
                --bg-primary: #f4f7fc;        
                --bg-secondary: #ffffff;     
                --bg-tertiary: #e9eff6;     
                --text-primary: #1a202c;    
                --text-secondary: #4a5568;  
                --text-accent: #3a7bd5;     
                --accent-primary: #3a7bd5;  
                --accent-secondary: #00d2ff; 
                --accent-gradient: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
                --border-color: #e2e8f0;     
                --danger-color: #e53e3e;      
                --success-color: #38a169;     
                --card-bg: rgba(255, 255, 255, 0.75);
                --card-border: rgba(255, 255, 255, 0.5);
                --input-bg: rgba(233, 239, 246, 0.8); 
                 --shadow-color-base: rgba(50, 50, 93, 0.15);
                 --shadow-md: 0 5px 15px var(--shadow-color-base);
                 --shadow-lg: 0 15px 35px var(--shadow-color-base);
            }
            .theme-dark {
                --bg-primary: #121828;        
                --bg-secondary: #1a2238;     
                --bg-tertiary: #253053;     
                --text-primary: #e2e8f0;    
                --text-secondary: #a0aec0;  
                --text-accent: #23d997;     
                --accent-primary: #23d997;  
                --accent-secondary: #00aeff; 
                --accent-gradient: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
                --border-color: rgba(255, 255, 255, 0.1); 
                --danger-color: #ff6b6b;      
                --success-color: #54e093;     
                --card-bg: rgba(26, 34, 56, 0.75); 
                --card-border: rgba(255, 255, 255, 0.1);
                --input-bg: rgba(37, 48, 83, 0.8); 
                 --shadow-color-base: rgba(0, 0, 0, 0.3);
                 --shadow-md: 0 8px 20px var(--shadow-color-base);
                 --shadow-lg: 0 15px 40px var(--shadow-color-base);
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            html {
                 scroll-behavior: smooth;
            }
            body {
                font-family: var(--font-main);
                background-color: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                min-height: 100vh;
                 transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            }
            .container {
                max-width: 1200px;
                margin: 2vh auto;
                padding: 1vh 2vh;
            }
             .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 3vh;
                padding-top: 1vh;
                flex-wrap: wrap; 
                gap: 1vh; 
             }
             .header-title {
                 text-align: left;
             }
            h1 {
                font-size: clamp(2vh, 5vw, 2.8vh); 
                font-weight: 700;
                background: var(--accent-gradient);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 0.3vh;
                letter-spacing: -0.5px;
            }
            h1 i {
                margin-right: 10px;
                 background: none; 
                -webkit-text-fill-color: var(--accent-primary); 
            }
            .subtitle {
                color: var(--text-secondary);
                font-size: clamp(0.9vh, 2vw, 1.1vh);
                font-weight: 400;
            }
             .theme-switcher {
                 display: flex;
                 background-color: var(--bg-secondary);
                 border-radius: 50px;
                 padding: 5px;
                 box-shadow: var(--shadow-sm);
                 border: 1px solid var(--border-color);
             }
             .theme-switcher button {
                 background: none;
                 border: none;
                 color: var(--text-secondary);
                 padding: 8px 12px;
                 border-radius: 50px;
                 cursor: pointer;
                 transition: all var(--transition-speed) ease;
                 font-size: 1vh;
             }
             .theme-switcher button.active {
                 background: var(--accent-gradient);
                 color: #fff; 
                 box-shadow: 0 2px 5px rgba(0,0,0,0.2);
             }
              .theme-switcher button:not(.active):hover {
                  color: var(--text-primary);
              }
              .theme-switcher button i {
                  vertical-align: middle;
              }
            .card {
                background-color: var(--card-bg);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px); 
                border-radius: var(--border-radius-lg);
                padding: clamp(1.5vh, 4vw, 2.5vh); 
                margin-bottom: 2.5vh;
                box-shadow: var(--shadow-lg);
                border: 1px solid var(--card-border);
                transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            }
            .tabs {
                display: flex;
                margin-bottom: 2vh;
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius-md);
                overflow: hidden;
                box-shadow: var(--shadow-sm);
                 border: 1px solid var(--border-color);
            }
            .tab {
                flex: 1;
                padding: 1vh 1.5vh;
                text-align: center;
                background-color: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all var(--transition-speed) ease-in-out;
                font-weight: 600;
                font-size: 1.05vh;
                border-bottom: 3px solid transparent;
                position: relative;
            }
            .tab i { margin-right: 10px; }
            .tab:hover {
                color: var(--text-primary);
            }
            .tab.active {
                color: var(--accent-primary);
                background-color: var(--bg-tertiary);
                border-bottom-color: var(--accent-primary);
            }
            .tab-content { display: none; }
            .tab-content.active {
                display: block;
                animation: subtleFadeIn 0.5s ease-in-out forwards;
             }
             @keyframes subtleFadeIn {
                from { opacity: 0.7; transform: translateY(5px); }
                to { opacity: 1; transform: translateY(0); }
             }
            .controls-section {
                 display: flex;
                 flex-wrap: wrap;
                 gap: 2vh;
                 margin-bottom: 2vh;
                 padding: 1.5vh;
                 background-color: var(--bg-secondary);
                 border-radius: var(--border-radius-md);
                  border: 1px solid var(--border-color);
                  box-shadow: var(--shadow-sm);
            }
            .control-group {
                 display: flex;
                 align-items: center;
                 gap: 0.8vh;
                 flex: 1 1 250px; 
            }
             .control-group label {
                font-weight: 600;
                color: var(--text-primary);
                white-space: nowrap;
                font-size: 0.95vh;
             }
             .control-group label i {
                 margin-right: 5px;
                 color: var(--accent-primary);
             }
             .control-group select, .control-group input[type="number"] {
                width: auto; 
                flex-grow: 1; 
                padding: 0.7vh 1vh;
                border-radius: var(--border-radius-sm);
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--text-primary);
                font-family: inherit;
                font-size: 1vh;
                cursor: pointer;
                transition: all var(--transition-speed) ease;
                min-width: 150px; 
             }
             .control-group select:focus, .control-group input:focus {
                outline: none;
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 2px rgba(var(--accent-primary-rgb), 0.2); 
             }
             .theme-light { --accent-primary-rgb: 58, 123, 213; }
             .theme-dark { --accent-primary-rgb: 35, 217, 151; }
            .semester-section {
                margin-bottom: 2.5vh;
                padding: 2vh;
                background: var(--bg-tertiary);
                border-radius: var(--border-radius-md);
                border: 1px solid var(--border-color);
                 transition: background-color var(--transition-speed) ease;
            }
            .semester-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5vh;
                padding-bottom: 1vh;
                border-bottom: 1px solid var(--border-color);
            }
            h3 {
                color: var(--accent-primary);
                font-weight: 600;
                font-size: 1.5vh;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .courses-table-wrapper {
                overflow-x: auto; 
                 margin-bottom: 1.5vh;
            }
            .courses-table {
                width: 100%;
                min-width: 700px; 
                border-collapse: separate; 
                border-spacing: 0 8px; 
            }
            .courses-table thead tr {
                 background-color: transparent; 
            }
            .courses-table th {
                padding: 1vh 1.2vh;
                text-align: left;
                font-weight: 600;
                color: var(--text-secondary);
                text-transform: uppercase;
                font-size: 0.85vh;
                letter-spacing: 0.8px;
                border-bottom: 2px solid var(--border-color);
                 white-space: nowrap;
            }
             .courses-table th:first-child { border-top-left-radius: var(--border-radius-sm); }
             .courses-table th:last-child { border-top-right-radius: var(--border-radius-sm); }
             .courses-table th:nth-child(5) { text-align: center;} 
            .courses-table tbody tr {
                 background-color: var(--bg-secondary);
                 border-radius: var(--border-radius-sm);
                 box-shadow: var(--shadow-sm);
                 transition: transform 0.2s ease, box-shadow 0.2s ease;
                 border: 1px solid var(--border-color);
            }
             .courses-table tbody tr:hover {
                 transform: translateY(-2px);
                 box-shadow: var(--shadow-md);
             }
            .courses-table td {
                padding: 1vh 1.2vh;
                vertical-align: middle;
                 border: none; 
                 border-top: 1px solid var(--border-color); 
            }
             .courses-table td:first-child { border-left: 1px solid var(--border-color); border-top-left-radius: var(--border-radius-sm); border-bottom-left-radius: var(--border-radius-sm); }
             .courses-table td:last-child { border-right: 1px solid var(--border-color); border-top-right-radius: var(--border-radius-sm); border-bottom-right-radius: var(--border-radius-sm); text-align: center; }
             .courses-table tbody tr td { border-bottom: 1px solid var(--border-color); }
            .courses-table input, .courses-table select {
                width: 100%;
                padding: 0.8vh 1vh;
                border-radius: var(--border-radius-sm);
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--text-primary);
                font-size: 0.95vh;
                transition: all var(--transition-speed) ease;
                font-family: inherit;
            }
            .courses-table input[type="number"]
            .courses-table input::-webkit-outer-spin-button,
            .courses-table input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            .courses-table input:focus, .courses-table select:focus {
                outline: none;
                border-color: var(--accent-primary);
                background-color: var(--bg-secondary);
                 box-shadow: 0 0 0 2px rgba(var(--accent-primary-rgb), 0.2);
            }
            .courses-table input.invalid, .courses-table select.invalid {
                 border-color: var(--danger-color);
                 box-shadow: 0 0 0 2px rgba(var(--danger-color-rgb), 0.2);
            }
             .theme-light { --danger-color-rgb: 229, 62, 62; }
             .theme-dark { --danger-color-rgb: 255, 107, 107; }
             .validation-message {
                 font-size: 0.8vh;
                 color: var(--danger-color);
                 margin-top: 4px;
                 display: none; 
             }
             .invalid + .validation-message {
                 display: block;
             }
            .btn {
                background: var(--accent-gradient);
                color: #fff; 
                border: none;
                padding: 0.8vh 1.8vh;
                border-radius: 50px;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.95vh;
                transition: all var(--transition-speed) ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                box-shadow: 0 4px 10px rgba(var(--accent-primary-rgb), 0.3);
                 position: relative;
                 overflow: hidden;
                 z-index: 1;
            }
             .btn::before {
                 content: '';
                 position: absolute;
                 top: 0;
                 left: -100%;
                 width: 100%;
                 height: 100%;
                 background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
                 transition: left 0.6s ease;
                  z-index: -1;
             }
             .btn:hover::before {
                 left: 100%;
             }
            .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 15px rgba(var(--accent-primary-rgb), 0.4);
            }
            .btn:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(var(--accent-primary-rgb), 0.3);
            }
            .btn-secondary {
                 background: var(--bg-secondary);
                 color: var(--text-primary);
                 border: 1px solid var(--border-color);
                  box-shadow: var(--shadow-sm);
            }
             .btn-secondary:hover {
                border-color: var(--accent-primary);
                color: var(--accent-primary);
                 box-shadow: 0 6px 12px rgba(var(--accent-primary-rgb), 0.2);
             }
              .btn-secondary:hover::before { display: none; } 
            .btn-danger {
                background: transparent;
                color: var(--danger-color);
                padding: 0;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: inline-flex;
                justify-content: center;
                align-items: center;
                 border: 1px solid var(--border-color);
                  box-shadow: none;
            }
            .btn-danger:hover {
                background-color: rgba(var(--danger-color-rgb), 0.1);
                color: var(--danger-color);
                 border-color: var(--danger-color);
                transform: scale(1.1);
                 box-shadow: none;
            }
             .btn-danger:active { transform: scale(1.05); }
             .btn-danger i { margin: 0; }
              .btn-danger:hover::before { display: none; }
            .add-course-btn { margin-top: 1vh; }
            .actions {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 2.5vh;
                flex-wrap: wrap;
                gap: 1.5vh;
                border-top: 1px solid var(--border-color);
                padding-top: 2vh;
            }
             .actions > div {
                 display: flex;
                 gap: 1vh;
                 flex-wrap: wrap;
             }
             .actions .export-btn { 
                background: var(--success-color);
                 box-shadow: 0 4px 10px rgba(var(--success-color-rgb), 0.3);
             }
              .theme-light { --success-color-rgb: 56, 161, 105; }
              .theme-dark { --success-color-rgb: 84, 224, 147; }
            .results-card {
                 text-align: center;
                 display: none; 
                 animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            }
             @keyframes popIn {
                0% { opacity: 0; transform: scale(0.8); }
                100% { opacity: 1; transform: scale(1); }
             }
            .result-header h2 {
                font-size: clamp(1.8vh, 4vw, 2.2vh);
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 2.5vh;
                position: relative;
                display: inline-block;
            }
            .result-header h2 i {
                 color: var(--accent-primary);
                 margin-right: 10px;
            }
            .result-header h2::after {
                content: '';
                position: absolute;
                bottom: -12px;
                left: 50%;
                transform: translateX(-50%);
                width: 80px;
                height: 4px;
                background: var(--accent-gradient);
                border-radius: 2px;
            }
            .cgpa-display-area {
                margin-bottom: 3vh;
                 display: flex;
                 flex-direction: column;
                 align-items: center;
                 gap: 1vh;
            }
             .cgpa-value-wrapper {
                width: 180px;
                height: 180px;
                border-radius: 50%;
                background: var(--bg-secondary);
                 border: 5px solid var(--border-color);
                 box-shadow: var(--shadow-md), inset 0 0 20px rgba(0,0,0,0.1);
                 display: flex;
                 justify-content: center;
                 align-items: center;
                 position: relative;
             }
             .cgpa-gauge-track {
                 position: absolute;
                 top: 0; left: 0; width: 100%; height: 100%;
                 transform: rotate(-90deg); 
             }
              .cgpa-gauge-progress {
                 fill: none;
                 stroke: url(#cgpa-gradient); 
                 stroke-width: 10;
                 stroke-linecap: round;
                 stroke-dasharray: 471; 
                 stroke-dashoffset: 471; 
                 transition: stroke-dashoffset 1s cubic-bezier(0.34, 1.56, 0.64, 1);
             }
             .cgpa-value {
                font-size: clamp(2.5vh, 6vw, 3.5vh);
                font-weight: 700;
                color: var(--accent-primary);
             }
             .cgpa-meta p {
                font-size: 1.1vh;
                color: var(--text-secondary);
             }
             .cgpa-meta #total-credits {
                font-weight: 600;
                color: var(--text-primary);
             }
             #target-gpa-suggestion {
                 font-size: 0.95vh;
                 color: var(--text-secondary);
                 margin-top: 1vh;
                 font-style: italic;
                 display: none; 
                 max-width: 500px;
                 margin-left: auto;
                 margin-right: auto;
             }
            .semester-summary, .grade-scale {
                margin-top: 3.5vh;
                 padding: 2vh;
                 background: var(--bg-secondary);
                 border-radius: var(--border-radius-md);
                 border: 1px solid var(--border-color);
                  box-shadow: var(--shadow-sm);
            }
            .semester-summary h3, .grade-scale h3 {
                margin-bottom: 2vh;
                text-align: center;
                font-size: 1.6vh;
                color: var(--text-primary);
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
            }
            .semester-summary h3 i, .grade-scale h3 i { color: var(--accent-primary); }
            #semester-chart-container {
                max-width: 800px;
                height: 350px; 
                margin: 0 auto;
            }
            .grade-table {
                width: 100%;
                max-width: 550px;
                margin: 0 auto;
                border-collapse: separate;
                border-spacing: 0 5px;
                text-align: center;
            }
            .grade-table th {
                 background: var(--bg-tertiary);
                 color: var(--text-primary);
                 padding: 0.8vh;
                 font-weight: 600;
                 border-bottom: 2px solid var(--border-color);
            }
             .grade-table th:first-child { border-top-left-radius: var(--border-radius-sm); border-bottom-left-radius: var(--border-radius-sm); }
             .grade-table th:last-child { border-top-right-radius: var(--border-radius-sm); border-bottom-right-radius: var(--border-radius-sm); }
             .grade-table td {
                 padding: 0.8vh;
                 background-color: var(--bg-secondary);
                 border: 1px solid var(--border-color);
                 border-width: 1px 0; 
             }
              .grade-table tr td:first-child { border-left: 1px solid var(--border-color); border-top-left-radius: var(--border-radius-sm); border-bottom-left-radius: var(--border-radius-sm); }
              .grade-table tr td:last-child { border-right: 1px solid var(--border-color); border-top-right-radius: var(--border-radius-sm); border-bottom-right-radius: var(--border-radius-sm); }
             .grade-table td:nth-child(2) { font-weight: 600; color: var(--success-color);} 
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: opacity var(--transition-speed) ease, visibility 0s linear var(--transition-speed);
            }
             .modal-overlay.show {
                 opacity: 1;
                 visibility: visible;
                 transition-delay: 0s;
             }
            .modal-content {
                background: var(--bg-secondary);
                padding: 2.5vh;
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg);
                text-align: center;
                max-width: 450px;
                 border: 1px solid var(--border-color);
                transform: scale(0.9);
                opacity: 0;
                transition: transform var(--transition-speed) ease, opacity var(--transition-speed) ease;
            }
             .modal-overlay.show .modal-content {
                 transform: scale(1);
                 opacity: 1;
             }
            .modal-content h4 {
                color: var(--text-primary);
                font-size: 1.6vh;
                font-weight: 600;
                margin-bottom: 1vh;
            }
            .modal-content p {
                margin-bottom: 2vh;
                color: var(--text-secondary);
                font-size: 1.05vh;
            }
            .modal-actions {
                display: flex;
                justify-content: center;
                gap: 1vh;
            }
             .modal-actions .btn { font-size: 0.9vh; padding: 0.7vh 1.5vh;}
             .modal-actions .btn-danger { background: var(--danger-color); box-shadow: 0 4px 10px rgba(var(--danger-color-rgb), 0.3); color: #fff;}
             .modal-actions .btn-danger:hover { background: var(--danger-color); filter: brightness(1.1); }
             .modal-actions .btn-secondary { background: var(--bg-tertiary); }
        </style>
    </head>
    <body>
        <svg width="0" height="0" style="position: absolute">
            <defs>
                <lineargradient
                    id="cgpa-gradient"
                    x1="0%"
                    y1="0%"
                    x2="0%"
                    y2="100%"
                >
                    <stop
                        offset="0%"
                        style="
                            stop-color: var(--accent-secondary);
                            stop-opacity: 1;
                        "
                    />
                    <stop
                        offset="100%"
                        style="
                            stop-color: var(--accent-primary);
                            stop-opacity: 1;
                        "
                    />
                </lineargradient>
            </defs>
        </svg>
        <div class="container">
            <header class="page-header">
                <div class="header-title">
                    <h1><i class="fas fa-rocket"></i> Ã‰lite CGPA Analyzer</h1>
                    <p class="subtitle">
                        Precision Calculations & Insightful Analytics
                    </p>
                </div>
                <div class="theme-switcher">
                    <button id="theme-light-btn" title="Switch to Light Theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button id="theme-dark-btn" title="Switch to Dark Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>
            <div class="control-group">
                <label for="grading-scale"
                    ><i class="fas fa-balance-scale-right"></i> Grading
                    Scale:</label
                >
                <select id="grading-scale">
                    <!-- Add your university scale as the primary/default option -->
                    <option value="university-4.0" selected>ADUST Scale (A+ = 4.00)</option>
                    <!-- You can optionally keep other scales for comparison, or remove them -->
                    <!-- <option value="4.0">Standard 4.0 Scale (A=4.0)</option> -->
                </select>
            </div>
            <div class="control-group">
                <label for="target-cgpa"
                    ><i class="fas fa-bullseye"></i> Target CGPA:</label
                >
                <input
                    type="number"
                    id="target-cgpa"
                    min="0"
                    max="4.00" 
                    step="0.01"
                    placeholder="e.g. 3.75 (Optional)"
                />
            </div>
                <div class="tabs">
                    <div class="tab active" data-tab="semester">
                        <i class="fas fa-layer-group"></i> Semester View
                    </div>
                    <div class="tab" data-tab="course">
                        <i class="fas fa-book-open"></i> Course View
                    </div>
                </div>
                <div id="semester-tab" class="tab-content active">
                    <div id="semesters-container">
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary add-semester-btn">
                            <i class="fas fa-plus-circle"></i> Add Semester
                        </button>
                        <div>
                            <button
                                class="btn export-btn"
                                id="export-csv-sem"
                                title="Export Semester Data to CSV"
                            >
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="btn calculate-btn">
                                <i class="fas fa-calculator"></i> Calculate
                            </button>
                            <button class="btn btn-danger reset-btn">
                                <i class="fas fa-undo-alt"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
                <div id="course-tab" class="tab-content">
                    <div class="courses-table-wrapper">
                        <table class="courses-table">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name (Optional)</th>
                                    <th>Credit Hours</th>
                                    <th>Grade</th>
                                    <th><i class="fas fa-trash-alt"></i></th>
                                </tr>
                            </thead>
                            <tbody id="course-tbody">
                            </tbody>
                        </table>
                    </div>
                    <button
                        class="btn btn-secondary add-course-btn"
                        data-tab="course"
                    >
                        <i class="fas fa-plus"></i> Add Course
                    </button>
                    <div class="actions">
                        <div></div>
                        <div>
                            <button
                                class="btn export-btn"
                                id="export-csv-course"
                                title="Export Course Data to CSV"
                            >
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="btn calculate-btn">
                                <i class="fas fa-calculator"></i> Calculate
                            </button>
                            <button class="btn btn-danger reset-btn">
                                <i class="fas fa-undo-alt"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card results-card" id="results">
                <div class="result-header">
                    <h2><i class="fas fa-chart-pie"></i> Analysis Results</h2>
                </div>
                <div class="cgpa-display-area">
                    <div class="cgpa-value-wrapper">
                        <svg class="cgpa-gauge-track" viewbox="0 0 160 160">
                            <circle
                                class="cgpa-gauge-progress"
                                id="cgpa-gauge-progress"
                                cx="80"
                                cy="80"
                                r="75"
                                stroke-width="10"
                            />
                        </svg>
                        <div class="cgpa-value" id="cgpa-value">0.00</div>
                    </div>
                    <div class="cgpa-meta">
                        <p>Cumulative GPA (CGPA)</p>
                        <p>
                            Across <strong id="total-credits">0</strong> total
                            credit hours
                        </p>
                    </div>
                    <p id="target-gpa-suggestion">
                        Enter a target CGPA above to see suggestions.
                    </p>
                </div>
                <div class="semester-summary" id="semester-summary">
                    <h3>
                        <i class="fas fa-chart-line"></i> Semester Performance
                        Trend
                    </h3>
                    <div id="semester-chart-container">
                        <canvas id="semesterChart"></canvas>
                    </div>
                </div>
                <div class="grade-scale">
                    <h3>
                        <i class="fas fa-tasks"></i> Grading Scale Reference
                    </h3>
                    <table class="grade-table" id="grade-table-ref">
                        <thead>
                            <tr>
                                <th>Grade Letter</th>
                                <th>Grade Points</th>
                            </tr>
                        </thead>
                        <tbody id="grade-table-ref-body">
                        </tbody>
                    </table>
                </div>
            </div>
        
        <div class="modal-overlay" id="confirmation-modal">
            <div class="modal-content">
                <h4>
                    <i
                        class="fas fa-exclamation-triangle"
                        style="color: var(--danger-color); margin-right: 10px"
                    ></i
                    >Confirm Action
                </h4>
                <p id="modal-message">
                    Are you sure you want to proceed? This action cannot be
                    undone.
                </p>
                <div class="modal-actions">
                    <button class="btn btn-danger" id="confirm-reset-btn">
                        <i class="fas fa-check-circle"></i> Confirm
                    </button>
                    <button class="btn btn-secondary" id="cancel-reset-btn">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
        <script>
// --- START OF FILE cgpa-calculator.js ---

document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Element Selection ---
    const htmlElement = document.documentElement;
    const themeLightBtn = document.getElementById('theme-light-btn');
    const themeDarkBtn = document.getElementById('theme-dark-btn');
    const gradingScaleSelect = document.getElementById('grading-scale');
    const targetCgpaInput = document.getElementById('target-cgpa');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const semestersContainer = document.getElementById('semesters-container');
    const courseTbody = document.getElementById('course-tbody');
    const calculateBtns = document.querySelectorAll('.calculate-btn');
    const resetBtns = document.querySelectorAll('.reset-btn');
    const resultsCard = document.getElementById('results');
    const cgpaValueEl = document.getElementById('cgpa-value');
    const totalCreditsEl = document.getElementById('total-credits');
    const cgpaGaugeProgress = document.getElementById('cgpa-gauge-progress');
    const targetGpaSuggestionEl = document.getElementById('target-gpa-suggestion');
    const semesterChartCanvas = document.getElementById('semesterChart');
    const gradeTableRefBody = document.getElementById('grade-table-ref-body');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalMessage = document.getElementById('modal-message');
    const confirmResetBtn = document.getElementById('confirm-reset-btn');
    const cancelResetBtn = document.getElementById('cancel-reset-btn');
    const exportCsvSemBtn = document.getElementById('export-csv-sem');
    const exportCsvCourseBtn = document.getElementById('export-csv-course');

    // --- State Variables ---
    let semesterCounter = 0;
    let semesterChartInstance = null;
    const GAUGE_CIRCUMFERENCE = 2 * Math.PI * 75; // Corresponds to r="75" in SVG

    // --- Grade Point Definitions ---
    // Updated for the specific university scale
    const gradeScaleDefinitions = {
        'university-4.0': {
            maxPoints: 4.00,
            grades: {
                'A+': { points: 4.00, interpretation: 'Outstanding' },
                'A':  { points: 3.75, interpretation: 'Excellent' },
                'A-': { points: 3.50, interpretation: 'Quite Excellent' },
                'B+': { points: 3.25, interpretation: 'Very Good' },
                'B':  { points: 3.00, interpretation: 'Good' },
                'B-': { points: 2.75, interpretation: 'Quite Good' },
                'C+': { points: 2.50, interpretation: 'Above Average' },
                'C':  { points: 2.25, interpretation: 'Average' },
                'D':  { points: 2.00, interpretation: 'Poor' },
                'F':  { points: 0.00, interpretation: 'Fail' },
                'W':  { points: 0.00, interpretation: 'Withdrawn', ignoreInCalc: true }, // Will have 0 points but ignored in total credits
                'I':  { points: 0.00, interpretation: 'Incomplete', ignoreInCalc: true }, // Will have 0 points but ignored in total credits
                'P':  { points: null, interpretation: 'Passed', ignoreInCalc: true },     // No points, ignored in calc
                'E':  { points: null, interpretation: 'Exempted', ignoreInCalc: true }    // No points, ignored in calc
            }
        },
        // Example: Keep standard 4.0 if needed for comparison
        // '4.0': {
        //     maxPoints: 4.0,
        //     grades: { 'A': 4.0, 'A-': 3.7, 'B+': 3.3, 'B': 3.0, 'B-': 2.7, 'C+': 2.3, 'C': 2.0, 'C-': 1.7, 'D+': 1.3, 'D': 1.0, 'F': 0.0 }
        // }
    };

    // --- Initialization ---
    function initializeCalculator() {
        setupTheme();
        setupEventListeners();
        addSemester(); // Add the first semester by default
        addCourseRow(courseTbody); // Add an initial row to the course tab
        updateGradeScaleReferenceTable();
        updateTargetCgpaMax(); // Ensure max is set correctly on load
    }

    // --- Theme Management ---
    function setupTheme() {
        const savedTheme = localStorage.getItem('cgpa-theme') || 'theme-dark'; // Default to dark
        applyTheme(savedTheme);

        themeLightBtn.addEventListener('click', () => applyTheme('theme-light'));
        themeDarkBtn.addEventListener('click', () => applyTheme('theme-dark'));
    }

    function applyTheme(themeName) {
        htmlElement.className = themeName;
        localStorage.setItem('cgpa-theme', themeName);
        themeLightBtn.classList.toggle('active', themeName === 'theme-light');
        themeDarkBtn.classList.toggle('active', themeName === 'theme-dark');
        if (semesterChartInstance) {
            updateChartAppearance();
        }
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        // Tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        // Grading Scale Change
        gradingScaleSelect.addEventListener('change', handleGradingScaleChange);

        // Target CGPA Input Change
        targetCgpaInput.addEventListener('input', () => {
            if (resultsCard.style.display !== 'none') {
                updateTargetSuggestion(); // Recalculate suggestion if results are visible
            }
        });

        // Add Semester Button
        document.querySelector('.add-semester-btn').addEventListener('click', addSemester);

        // Add Course Button (Course Tab)
        document.querySelector('.add-course-btn[data-tab="course"]').addEventListener('click', () => addCourseRow(courseTbody));

        // Calculate Buttons
        calculateBtns.forEach(btn => btn.addEventListener('click', handleCalculate));

        // Reset Buttons
        resetBtns.forEach(btn => btn.addEventListener('click', () => showConfirmationModal('Are you sure you want to reset all fields? This action cannot be undone.')));

        // Modal Buttons
        confirmResetBtn.addEventListener('click', () => {
            resetForm();
            hideConfirmationModal();
        });
        cancelResetBtn.addEventListener('click', hideConfirmationModal);
        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                hideConfirmationModal();
            }
        });

        // Export Buttons
        exportCsvSemBtn.addEventListener('click', () => exportData('semester'));
        exportCsvCourseBtn.addEventListener('click', () => exportData('course'));

        // Dynamic Element Event Delegation
        semestersContainer.addEventListener('click', handleSemesterContainerClick);
        courseTbody.addEventListener('click', handleCourseTbodyClick);

        // Input Validation Delegation
        semestersContainer.addEventListener('input', handleInputValidation);
        semestersContainer.addEventListener('change', handleInputValidation);
        courseTbody.addEventListener('input', handleInputValidation);
        courseTbody.addEventListener('change', handleInputValidation);
    }

    // --- Event Handlers ---

    function handleSemesterContainerClick(e) {
        if (e.target.closest('.add-course-btn-sem')) {
            const semesterSection = e.target.closest('.semester-section');
            const tbody = semesterSection.querySelector('.courses-table tbody');
            addCourseRow(tbody);
        } else if (e.target.closest('.remove-course-btn')) {
            e.target.closest('tr').remove();
        } else if (e.target.closest('.remove-semester-btn')) {
            e.target.closest('.semester-section').remove();
        }
    }

    function handleCourseTbodyClick(e) {
        if (e.target.closest('.remove-course-btn')) {
            e.target.closest('tr').remove();
        }
    }

    function handleInputValidation(e) {
        if (e.target.matches('input[type="number"], select')) {
            validateInput(e.target);
        }
    }

    function handleGradingScaleChange() {
        updateTargetCgpaMax();
        updateAllGradeSelects();
        updateGradeScaleReferenceTable();
        if (resultsCard.style.display !== 'none') {
            handleCalculate(); // Recalculate if scale changes and results are shown
        }
    }

    function handleCalculate() {
        if (!validateForm()) {
            alert('Please fix the errors in the form before calculating.');
            const firstError = document.querySelector('.invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
            return;
        }

        const activeTab = document.querySelector('.tab.active').dataset.tab;
        const scaleKey = gradingScaleSelect.value; // e.g., 'university-4.0'
        const calculationData = calculateGPA(activeTab, scaleKey);

        displayResults(calculationData, scaleKey);
    }

    // --- Tab Management ---
    function switchTab(targetTab) {
        tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === targetTab));
        tabContents.forEach(content => content.classList.toggle('active', content.id === `${targetTab}-tab`));
    }

    // --- Dynamic Element Creation ---
    function addSemester() {
        semesterCounter++;
        const semesterId = `semester-${semesterCounter}`;
        const semesterHTML = `
            <div class="semester-section" id="${semesterId}">
                <div class="semester-header">
                    <h3><i class="fas fa-calendar-alt"></i> Semester ${semesterCounter}</h3>
                    <button class="btn btn-danger remove-semester-btn" title="Remove Semester ${semesterCounter}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="courses-table-wrapper">
                    <table class="courses-table">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Name (Optional)</th>
                                <th>Credit Hours</th>
                                <th>Grade</th>
                                <th><i class="fas fa-trash-alt"></i></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="btn btn-secondary add-course-btn add-course-btn-sem">
                    <i class="fas fa-plus"></i> Add Course to Semester ${semesterCounter}
                </button>
            </div>
        `;
        semestersContainer.insertAdjacentHTML('beforeend', semesterHTML);
        const newSemesterTbody = semestersContainer.querySelector(`#${semesterId} tbody`);
        addCourseRow(newSemesterTbody);
    }

    function addCourseRow(tbody) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" placeholder="e.g. CS101"></td>
            <td><input type="text" placeholder="e.g. Intro to Programming"></td>
            <td>
                <input type="number" min="0" step="0.5" placeholder="e.g. 3">
                <div class="validation-message">Credits must be > 0</div>
            </td>
            <td>
                <select>
                    <option value="">Select Grade</option>
                    <!-- Options added dynamically -->
                </select>
                 <div class="validation-message">Please select a grade</div>
            </td>
            <td>
                <button class="btn btn-danger remove-course-btn" title="Remove Course">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        const gradeSelect = row.querySelector('select');
        updateGradeOptions(gradeSelect, gradingScaleSelect.value); // Use current scale
        tbody.appendChild(row);
    }

    // --- Grade Scale and Options Update ---
    function updateGradeOptions(selectElement, scaleKey) {
        const scale = gradeScaleDefinitions[scaleKey];
        if (!scale || !scale.grades) return;

        const currentGrades = scale.grades;
        const selectedValue = selectElement.value; // Preserve selection

        selectElement.innerHTML = '<option value="">Select Grade</option>'; // Clear existing

        // Add grades from the definition
        for (const grade in currentGrades) {
            const gradeInfo = currentGrades[grade];
            const option = document.createElement('option');
            option.value = grade;

            let displayText = grade;
            if (typeof gradeInfo.points === 'number') {
                displayText += ` (${gradeInfo.points.toFixed(2)})`; // Show points for numeric grades
            } else if (gradeInfo.interpretation) {
                 displayText += ` (${gradeInfo.interpretation})`; // Show interpretation for P/E
            }
            option.textContent = displayText;
            selectElement.appendChild(option);
        }

        // Restore selection if valid in the new scale
        if (currentGrades[selectedValue]) {
            selectElement.value = selectedValue;
        } else {
            selectElement.value = ""; // Reset if previous grade not valid
        }
        validateInput(selectElement); // Re-validate
    }

    function updateAllGradeSelects() {
        const allGradeSelects = document.querySelectorAll('.courses-table select');
        const scaleKey = gradingScaleSelect.value;
        allGradeSelects.forEach(select => updateGradeOptions(select, scaleKey));
    }

    function updateGradeScaleReferenceTable() {
        const scaleKey = gradingScaleSelect.value;
        const scale = gradeScaleDefinitions[scaleKey];
        gradeTableRefBody.innerHTML = ''; // Clear existing rows

        if (!scale || !scale.grades) {
             // Optionally display a message if scale not found
             gradeTableRefBody.innerHTML = '<tr><td colspan="3">Selected grading scale not defined.</td></tr>';
             // Adjust the header if the interpretation column is added
             const headerRow = gradeTableRefBody.closest('table').querySelector('thead tr');
             if (headerRow) {
                 headerRow.innerHTML = '<th>Grade Letter</th><th>Grade Points</th>'; // Default header
             }
             return;
        }

        const currentGrades = scale.grades;

        // Update header to include Interpretation
        const headerRow = gradeTableRefBody.closest('table').querySelector('thead tr');
        if (headerRow) {
            headerRow.innerHTML = '<th>Grade Letter</th><th>Grade Points</th><th>Interpretation</th>';
        }

        // Sort grades for display (optional, customize as needed)
        // This example sorts primarily by points (desc), then alphabetically for non-numeric
        const sortedGrades = Object.keys(currentGrades).sort((a, b) => {
            const pointsA = currentGrades[a].points;
            const pointsB = currentGrades[b].points;
            if (typeof pointsA === 'number' && typeof pointsB === 'number') {
                return pointsB - pointsA; // Sort numeric grades descending by points
            } else if (typeof pointsA === 'number') {
                return -1; // Numeric grades before non-numeric
            } else if (typeof pointsB === 'number') {
                return 1; // Non-numeric grades after numeric
            } else {
                return a.localeCompare(b); // Sort non-numeric alphabetically (P vs E)
            }
        });

        sortedGrades.forEach(grade => {
            const gradeInfo = currentGrades[grade];
            const row = document.createElement('tr');
            const pointsText = typeof gradeInfo.points === 'number' ? gradeInfo.points.toFixed(2) : 'â€”';
            const interpretationText = gradeInfo.interpretation || ''; // Use interpretation from definition

            row.innerHTML = `
                <td>${grade}</td>
                <td>${pointsText}</td>
                <td>${interpretationText}</td>
            `;
            gradeTableRefBody.appendChild(row);
        });
    }

    function updateTargetCgpaMax() {
        const scaleKey = gradingScaleSelect.value;
        const scale = gradeScaleDefinitions[scaleKey];
        const maxPoints = scale ? scale.maxPoints : 4.0; // Default to 4.0 if scale not found

        targetCgpaInput.max = maxPoints.toFixed(2);
        if (parseFloat(targetCgpaInput.value) > maxPoints) {
            targetCgpaInput.value = maxPoints.toFixed(2);
        }
    }

    // --- Input Validation ---
     function validateInput(inputElement) {
        let isValid = true;
        const validationMessage = inputElement.nextElementSibling;

        if (inputElement.type === 'number') {
            const value = parseFloat(inputElement.value);
            // Credits must be a positive number
            isValid = !isNaN(value) && value > 0;
            // Allow empty initially, but calculation will require it
            if (inputElement.value.trim() === '') isValid = true;
        } else if (inputElement.tagName === 'SELECT') {
            // Grade must be selected (any option other than the default empty one)
            isValid = inputElement.value !== "";
        }

        // Show validation message only if not empty and invalid
        const showMessage = !isValid && inputElement.value.trim() !== '';
        inputElement.classList.toggle('invalid', showMessage);
        if (validationMessage) {
            validationMessage.style.display = showMessage ? 'block' : 'none';
        }
        // Return true if valid OR if the input is currently empty
        return isValid || inputElement.value.trim() === '';
    }

    function validateForm() {
        const activeTab = document.querySelector('.tab.active').dataset.tab;
        let allValid = true;
        let inputsToValidate;

        if (activeTab === 'semester') {
            inputsToValidate = semestersContainer.querySelectorAll('.courses-table input[type="number"], .courses-table select');
        } else { // course tab
            inputsToValidate = courseTbody.querySelectorAll('input[type="number"], select');
        }

        // Validate only rows that have *some* input (either credits or grade)
        const rows = new Set(); // Keep track of rows to validate
        inputsToValidate.forEach(input => rows.add(input.closest('tr')));

        rows.forEach(row => {
            const creditInput = row.querySelector('input[type="number"]');
            const gradeSelect = row.querySelector('select');

            // Only validate if the row is not completely empty
            if (creditInput.value.trim() !== '' || gradeSelect.value !== '') {
                if (!validateInput(creditInput)) allValid = false;
                if (!validateInput(gradeSelect)) allValid = false;
            } else {
                // If row is empty, clear any previous validation errors on it
                creditInput.classList.remove('invalid');
                gradeSelect.classList.remove('invalid');
                const creditMsg = creditInput.nextElementSibling;
                const gradeMsg = gradeSelect.nextElementSibling;
                if (creditMsg) creditMsg.style.display = 'none';
                if (gradeMsg) gradeMsg.style.display = 'none';
            }
        });

        return allValid;
    }


    // --- Calculation ---
    function getGradeInfo(grade, scaleKey) {
        const scale = gradeScaleDefinitions[scaleKey];
        return scale?.grades?.[grade] ?? null; // Return the whole info object or null
    }

    function calculateGPA(activeTab, scaleKey) {
        let totalQualityPoints = 0;
        let totalCreditsAttempted = 0; // All credits with A-F, W, I
        let totalCreditsEarnedForGPA = 0; // Only credits with A-F (used for GPA calc)
        const semesterData = [];

        const processRow = (row, semesterNumber = null) => {
            const creditInput = row.querySelector('input[type="number"]');
            const gradeSelect = row.querySelector('select');
            const credits = parseFloat(creditInput.value);
            const grade = gradeSelect.value;

            if (isNaN(credits) || credits <= 0 || grade === "") {
                return null; // Skip incomplete rows
            }

            const gradeInfo = getGradeInfo(grade, scaleKey);

            if (!gradeInfo) {
                 console.warn(`Grade info not found for grade: ${grade} in scale: ${scaleKey}`);
                 return null; // Skip rows with undefined grades
            }

            // Accumulate attempted credits (A-F, W, I)
            // Accumulate GPA credits only if not marked to ignore (A-F)
            let qualityPoints = 0;
            let isGPACreditable = false;

            if (!gradeInfo.ignoreInCalc && typeof gradeInfo.points === 'number') {
                 // This includes A+ through F
                 qualityPoints = credits * gradeInfo.points;
                 totalCreditsEarnedForGPA += credits;
                 isGPACreditable = true;
            }
             // W and I have points=0 but ignoreInCalc=true, so they won't add to totalCreditsEarnedForGPA
             // P and E have points=null and ignoreInCalc=true, also won't add

             // All valid rows contribute to attempted credits
             totalCreditsAttempted += credits;


            return { credits, qualityPoints, isGPACreditable };
        };

        if (activeTab === 'semester') {
            const semesterSections = semestersContainer.querySelectorAll('.semester-section');
            semesterSections.forEach((section, index) => {
                let semesterQualityPoints = 0;
                let semesterCreditsForGPA = 0;
                const semesterNumber = index + 1;
                const courseRows = section.querySelectorAll('tbody tr');

                courseRows.forEach(row => {
                    const rowResult = processRow(row, semesterNumber);
                    if (rowResult && rowResult.isGPACreditable) {
                        semesterQualityPoints += rowResult.qualityPoints;
                        semesterCreditsForGPA += rowResult.credits;
                    }
                });

                if (semesterCreditsForGPA > 0) {
                    const sgpa = semesterQualityPoints / semesterCreditsForGPA;
                    semesterData.push({ semester: semesterNumber, sgpa: sgpa });
                    totalQualityPoints += semesterQualityPoints; // Add semester points to total
                }
                 // Note: totalCreditsEarnedForGPA is accumulated globally in processRow
            });
        } else { // course tab
            const courseRows = courseTbody.querySelectorAll('tr');
            courseRows.forEach(row => {
                 const rowResult = processRow(row);
                 if (rowResult && rowResult.isGPACreditable) {
                     totalQualityPoints += rowResult.qualityPoints; // Add row points to total
                 }
                 // Note: totalCreditsEarnedForGPA is accumulated globally in processRow
            });
        }

        // Calculate CGPA based on credits that count towards GPA (A-F)
        const cgpa = totalCreditsEarnedForGPA > 0 ? totalQualityPoints / totalCreditsEarnedForGPA : 0;

        // Return both GPA credits and attempted credits if needed elsewhere
        return { cgpa, totalCredits: totalCreditsEarnedForGPA, semesterData, totalCreditsAttempted };
    }

    // --- Display Results ---
    function displayResults(resultData, scaleKey) {
        const { cgpa, totalCredits, semesterData } = resultData; // totalCredits here is GPA credits
        const scale = gradeScaleDefinitions[scaleKey];
        const maxScale = scale ? scale.maxPoints : 4.0; // Use maxPoints from definition

        // Update CGPA value and total credits (displaying GPA credits)
        cgpaValueEl.textContent = cgpa.toFixed(2);
        totalCreditsEl.textContent = totalCredits.toFixed(1); // Credits used for GPA calc

        // Update CGPA Gauge
        const gaugeProgress = Math.max(0, Math.min(1, cgpa / maxScale));
        const offset = GAUGE_CIRCUMFERENCE * (1 - gaugeProgress);
        cgpaGaugeProgress.style.strokeDashoffset = offset;

        // Update Target Suggestion (pass GPA credits)
        updateTargetSuggestion(cgpa, totalCredits, maxScale);

        // Update or Create Semester Chart
        updateSemesterChart(semesterData, maxScale);

        // Show results card and scroll
        resultsCard.style.display = 'block';
        resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

     function updateTargetSuggestion(currentCgpa, currentCreditsForGPA, maxScale) {
        const targetCgpa = parseFloat(targetCgpaInput.value);

        if (!isNaN(targetCgpa) && targetCgpa > 0 && targetCgpa <= maxScale) {
            if (currentCreditsForGPA === 0) {
                 targetGpaSuggestionEl.textContent = `Start strong! Aim for an average grade point of ${targetCgpa.toFixed(2)} in your first courses to meet your target.`;
            } else if (targetCgpa <= currentCgpa) {
                targetGpaSuggestionEl.textContent = `Congratulations! You've already met or exceeded your target CGPA of ${targetCgpa.toFixed(2)}. Keep up the great work!`;
            } else {
                 // Simplified suggestion
                 targetGpaSuggestionEl.textContent = `To reach your target CGPA of ${targetCgpa.toFixed(2)}, aim for an average grade point higher than your current CGPA (${currentCgpa.toFixed(2)}) in future courses.`;
                 // Add the more complex calculation example if desired (commented out in previous version)
            }
            targetGpaSuggestionEl.style.display = 'block';
        } else {
            targetGpaSuggestionEl.textContent = 'Enter a valid target CGPA (up to 4.00) above to see suggestions.';
             targetGpaSuggestionEl.style.display = (targetCgpaInput.value.trim() === '') ? 'block' : 'none';
        }
    }


    // --- Charting ---
    function updateSemesterChart(semesterData, maxScale) {
        const chartContainer = document.getElementById('semester-chart-container');
        const summarySection = document.getElementById('semester-summary');

        if (!semesterData || semesterData.length === 0) {
            summarySection.style.display = 'none';
             if (semesterChartInstance) {
                semesterChartInstance.destroy();
                semesterChartInstance = null;
            }
            return;
        }

        summarySection.style.display = 'block';

        const labels = semesterData.map(data => `Sem ${data.semester}`);
        const sgpaValues = semesterData.map(data => data.sgpa);

        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Semester GPA (SGPA)',
                data: sgpaValues,
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointHoverRadius: 8,
            }]
        };

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: maxScale, // Use the correct max scale (4.00)
                    // Dynamic colors handled by applyChartThemeColors
                },
                x: {
                     grid: { display: false },
                     // Dynamic colors handled by applyChartThemeColors
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    // Dynamic colors handled by applyChartThemeColors
                     callbacks: {
                        label: function(context) {
                            return `SGPA: ${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            }
        };

        applyChartThemeColors(chartData.datasets[0], chartOptions); // Apply theme colors

        if (semesterChartInstance) {
            semesterChartInstance.data = chartData;
            semesterChartInstance.options = chartOptions;
            semesterChartInstance.update();
        } else {
            semesterChartInstance = new Chart(semesterChartCanvas, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });
        }
    }

     function applyChartThemeColors(dataset, options) {
        // This function remains largely the same, dynamically picking up CSS vars
        const style = getComputedStyle(htmlElement);
        const accentColor = style.getPropertyValue('--accent-primary').trim();
        const accentSecondaryColor = style.getPropertyValue('--accent-secondary').trim();
        const borderColor = style.getPropertyValue('--border-color').trim();
        const textColor = style.getPropertyValue('--text-secondary').trim();
        const bgColor = style.getPropertyValue('--bg-tertiary').trim();
        const textPrimaryColor = style.getPropertyValue('--text-primary').trim();

        const ctx = semesterChartCanvas.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, `${accentColor}B3`);
        gradient.addColorStop(1, `${accentSecondaryColor}33`);

        dataset.borderColor = accentColor;
        dataset.backgroundColor = gradient;
        dataset.pointBackgroundColor = accentColor;
        dataset.pointBorderColor = style.getPropertyValue('--bg-secondary').trim();
        dataset.pointHoverBackgroundColor = accentSecondaryColor;
        dataset.pointHoverBorderColor = style.getPropertyValue('--bg-secondary').trim();

        if (options.scales.y.grid) options.scales.y.grid.color = borderColor;
        if (options.scales.y.ticks) options.scales.y.ticks.color = textColor;
        if (options.scales.x.ticks) options.scales.x.ticks.color = textColor;
        if (options.plugins.tooltip) {
             options.plugins.tooltip.backgroundColor = bgColor;
             options.plugins.tooltip.titleColor = textPrimaryColor;
             options.plugins.tooltip.bodyColor = textColor;
        }
    }

    function updateChartAppearance() {
         if (!semesterChartInstance) return;
         applyChartThemeColors(semesterChartInstance.data.datasets[0], semesterChartInstance.options);
         semesterChartInstance.update();
    }


    // --- Reset Functionality ---
    function showConfirmationModal(message) {
        modalMessage.textContent = message;
        confirmationModal.classList.add('show');
    }

    function hideConfirmationModal() {
        confirmationModal.classList.remove('show');
    }

    function resetForm() {
        semestersContainer.innerHTML = '';
        courseTbody.innerHTML = '';
        semesterCounter = 0;

        // Reset to default university scale
        gradingScaleSelect.value = 'university-4.0';
        targetCgpaInput.value = '';
        updateTargetCgpaMax(); // Reset max to 4.00

        addSemester();
        addCourseRow(courseTbody);

        resultsCard.style.display = 'none';
        if (semesterChartInstance) {
            semesterChartInstance.destroy();
            semesterChartInstance = null;
        }

        cgpaValueEl.textContent = '0.00';
        totalCreditsEl.textContent = '0';
        cgpaGaugeProgress.style.strokeDashoffset = GAUGE_CIRCUMFERENCE;
        targetGpaSuggestionEl.textContent = 'Enter a target CGPA (up to 4.00) above to see suggestions.';
        targetGpaSuggestionEl.style.display = 'block';

        updateGradeScaleReferenceTable(); // Update reference table for the default scale

        document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        document.querySelectorAll('.validation-message').forEach(el => el.style.display = 'none');

        switchTab('semester');
    }

    // --- Export Functionality ---
    function exportData(type) {
        let dataRows = [];
        let headers = [];
        const scaleKey = gradingScaleSelect.value;

        function sanitizeCell(cellData) {
            const str = String(cellData ?? '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        if (type === 'semester') {
            headers = ['Semester', 'Course Code', 'Course Name', 'Credit Hours', 'Grade', 'Grade Points'];
            const semesterSections = semestersContainer.querySelectorAll('.semester-section');
            semesterSections.forEach((section, index) => {
                const semesterNumber = index + 1;
                const courseRows = section.querySelectorAll('tbody tr');
                let semesterHasRows = false;
                courseRows.forEach(row => {
                    const codeInput = row.querySelector('td:nth-child(1) input');
                    const nameInput = row.querySelector('td:nth-child(2) input');
                    const creditInput = row.querySelector('td:nth-child(3) input');
                    const gradeSelect = row.querySelector('td:nth-child(4) select');

                    const credits = parseFloat(creditInput.value);
                    const grade = gradeSelect.value;

                    // Include row in export if it has credits and a selected grade
                    if (!isNaN(credits) && credits > 0 && grade !== "") {
                         const gradeInfo = getGradeInfo(grade, scaleKey);
                         // Display points if numeric, otherwise '-' or empty
                         const pointsText = (gradeInfo && typeof gradeInfo.points === 'number') ? gradeInfo.points.toFixed(2) : '-';
                         dataRows.push([
                            semesterNumber,
                            sanitizeCell(codeInput.value),
                            sanitizeCell(nameInput.value),
                            credits,
                            grade,
                            pointsText // Export points or '-'
                        ]);
                        semesterHasRows = true;
                    }
                });
                 // Optional: Add empty row between semesters if the semester had data
                 // if (semesterHasRows && index < semesterSections.length - 1) {
                 //     dataRows.push(['','','','','','']);
                 // }
            });

        } else { // course tab
            headers = ['Course Code', 'Course Name', 'Credit Hours', 'Grade', 'Grade Points'];
             const courseRows = courseTbody.querySelectorAll('tr');
             courseRows.forEach(row => {
                 const codeInput = row.querySelector('td:nth-child(1) input');
                 const nameInput = row.querySelector('td:nth-child(2) input');
                 const creditInput = row.querySelector('td:nth-child(3) input');
                 const gradeSelect = row.querySelector('td:nth-child(4) select');

                 const credits = parseFloat(creditInput.value);
                 const grade = gradeSelect.value;

                 if (!isNaN(credits) && credits > 0 && grade !== "") {
                     const gradeInfo = getGradeInfo(grade, scaleKey);
                     const pointsText = (gradeInfo && typeof gradeInfo.points === 'number') ? gradeInfo.points.toFixed(2) : '-';
                     dataRows.push([
                         sanitizeCell(codeInput.value),
                         sanitizeCell(nameInput.value),
                         credits,
                         grade,
                         pointsText
                     ]);
                 }
             });
        }

        if (dataRows.length === 0) {
            alert("No valid data to export.");
            return;
        }

        const csvContent = [
            headers.join(','),
            ...dataRows.map(row => row.join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `cgpa-data-${type}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } else {
            alert("CSV export is not supported in your browser.");
        }
    }


    // --- Run Initializer ---
    initializeCalculator();

});
// --- END OF FILE cgpa-calculator.js ---
</script>
    </body>
</html>