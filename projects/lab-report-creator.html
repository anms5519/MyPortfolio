<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Kholipha's Reports - Academic Report Creator</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css"
            integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <style>
            :root {
                --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
                --border-radius-sm: 4px;
                --border-radius-md: 8px;
                --border-radius-lg: 12px;
                --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
                --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.08);
                --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.12);
                --shadow-xl: 0 20px 50px rgba(0, 0, 0, 0.15);
                --transition-speed: 0.25s;
                --modal-backdrop-color: rgba(0, 0, 0, 0.65);
                --max-width: 1600px;
            }
            body:not(.theme-dark) {
                --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #eef2f7 100%);
                --primary-color: #3B82F6;
                --primary-color-hover: #2563EB;
                --primary-color-active: #1D4ED8;
                --secondary-color: #6B7280;
                --accent-color: #EC4899;
                --text-color: #1F2937;
                --text-color-muted: #4B5563;
                --bg-color-main: #ffffff;
                --bg-color-sidebar: #f9fafb;
                --bg-color-elements: #f3f4f6;
                --bg-color-elements-hover: #e5e7eb;
                --border-color: #d1d5db;
                --border-color-strong: #9ca3af;
                --heading-color: #111827;
                --placeholder-color: #9ca3af;
                --icon-color: var(--primary-color);
                --btn-text-color: #ffffff;
                --danger-color: #EF4444;
                --success-color: #10B981;
                --warning-color: #F59E0B;
                --info-color: #0EA5E9;
                --modal-bg-color: var(--bg-color-main);
                --code-bg: #f3f4f6;
                --code-text: #374151;
                --link-color: var(--primary-color);
                --shadow-color-rgb: 0, 0, 0;
            }
            body.theme-dark {
                --bg-gradient: linear-gradient(135deg, #1f2937 0%, #111827 100%);
                --primary-color: #60A5FA;
                --primary-color-hover: #3B82F6;
                --primary-color-active: #2563EB;
                --secondary-color: #9CA3AF;
                --accent-color: #F472B6;
                --text-color: #D1D5DB;
                --text-color-muted: #9CA3AF;
                --bg-color-main: #1f2937;
                --bg-color-sidebar: #111827;
                --bg-color-elements: #374151;
                --bg-color-elements-hover: #4B5563;
                --border-color: #4B5563;
                --border-color-strong: #6B7280;
                --heading-color: #F9FAFB;
                --placeholder-color: #6B7280;
                --icon-color: var(--primary-color);
                --btn-text-color: #ffffff;
                --danger-color: #F87171;
                --success-color: #34D399;
                --warning-color: #FBBF24;
                --info-color: #38BDF8;
                --modal-bg-color: #374151;
                --code-bg: #111827;
                --code-text: #e5e7eb;
                --link-color: var(--primary-color);
                --shadow-color-rgb: 96, 165, 250;
            }
            *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
            html { scroll-behavior: smooth; }
            body {
                font-family: var(--font-family);
                background: var(--bg-gradient);
                color: var(--text-color);
                line-height: 1.65;
                font-size: 16px;
                overflow-x: hidden;
                transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            ::-webkit-scrollbar { width: 10px; height: 10px; }
            ::-webkit-scrollbar-track { background: transparent; }
            body.theme-dark ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 5px; border: 2px solid var(--bg-color-sidebar); }
            body.theme-dark ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
            body:not(.theme-dark) ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 5px; border: 2px solid var(--bg-color-sidebar); }
            body:not(.theme-dark) ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
            .container { max-width: var(--max-width); margin: 2rem auto; padding: 0 1.5rem; transition: max-width var(--transition-speed) ease; }
            header { text-align: center; margin-bottom: 2.5rem; position: relative; }
            h1.main-title {
                font-size: 2.25rem;
                font-weight: 800;
                background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 0.25rem;
                letter-spacing: -0.5px;
            }
            .subtitle { color: var(--text-color-muted); font-size: 0.9rem; margin-bottom: 1rem; }
            .header-controls { position: absolute; top: 0; right: 0; display: flex; gap: 0.75rem; }
            .control-btn {
                background: var(--bg-color-main);
                color: var(--text-color-muted);
                border: 1px solid var(--border-color);
                border-radius: 50%;
                width: 40px; height: 40px;
                display: flex; align-items: center; justify-content: center;
                cursor: pointer; transition: all var(--transition-speed) ease;
                font-size: 1rem; box-shadow: var(--shadow-xs);
            }
            .control-btn:hover {
                background-color: var(--primary-color); color: var(--btn-text-color);
                border-color: var(--primary-color); transform: scale(1.1) rotate(10deg);
                box-shadow: var(--shadow-md);
            }
            .app-layout {
                display: grid;
                grid-template-columns: 380px 1fr;
                gap: 1.75rem;
                transition: grid-template-columns var(--transition-speed) ease;
            }
            .app-layout.focus-mode { grid-template-columns: 0px 1fr; gap: 0; }
            .app-layout.focus-mode .sidebar {
                opacity: 0; visibility: hidden; transform: translateX(-100%);
                padding: 0; border: none; margin-right: -1.75rem;
            }
            .sidebar, .main-content {
                background-color: var(--bg-color-main);
                border-radius: var(--border-radius-lg);
                padding: 1.5rem;
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
                transition: all var(--transition-speed) ease;
                height: fit-content;
            }
            .sidebar { background-color: var(--bg-color-sidebar); }
            .form-group { margin-bottom: 1.25rem; position: relative; }
            .form-group label {
                display: block; margin-bottom: 0.5rem; font-weight: 500;
                color: var(--heading-color); font-size: 0.8rem;
                text-transform: uppercase; letter-spacing: 0.5px;
            }
            .form-control {
                width: 100%; padding: 0.75rem 1rem;
                border-radius: var(--border-radius-md);
                border: 1px solid var(--border-color);
                background-color: var(--bg-color-main);
                color: var(--text-color); font-family: inherit; font-size: 0.9rem;
                transition: all var(--transition-speed) ease; box-shadow: var(--shadow-xs);
            }
            .form-control:focus {
                outline: none; border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(var(--shadow-color-rgb), 0.3);
            }
            .form-control::placeholder { color: var(--placeholder-color); opacity: 0.8; }
            .form-group .tooltip-icon {
                position: absolute; top: calc(0.5rem + 1em + 12px);
                right: 1rem; color: var(--secondary-color); cursor: help;
                opacity: 0.6; transition: opacity var(--transition-speed); font-size: 0.9rem;
            }
            .form-group .tooltip-icon:hover { opacity: 1; color: var(--primary-color); }
            .btn {
                display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
                background: var(--primary-color); color: var(--btn-text-color);
                border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius-md);
                cursor: pointer; font-weight: 600; text-align: center;
                transition: all var(--transition-speed) ease;
                width: 100%; font-size: 0.9rem; box-shadow: var(--shadow-sm);
                text-transform: uppercase; letter-spacing: 0.8px;
                position: relative; overflow: hidden; z-index: 1;
            }
            .btn:hover:not(:disabled) {
                background: var(--primary-color-hover);
                transform: translateY(-2px); box-shadow: var(--shadow-md);
            }
            .btn:active:not(:disabled) {
                background: var(--primary-color-active);
                transform: translateY(0); box-shadow: var(--shadow-sm);
            }
            .btn:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(30%); }
            .btn i { transition: transform var(--transition-speed) ease; font-size: 1em; }
            .btn:hover:not(:disabled) i { transform: scale(1.1); }
            .btn-secondary {
                background: var(--bg-color-elements); color: var(--text-color);
                border: 1px solid var(--border-color);
            }
            .btn-secondary:hover:not(:disabled) { background: var(--bg-color-elements-hover); border-color: var(--border-color-strong); }
            .btn-danger { background: var(--danger-color); color: white; }
            .btn-danger:hover:not(:disabled) { background: color-mix(in srgb, var(--danger-color) 85%, black 15%); }
            .btn.btn-outline {
                background: transparent; border: 2px solid var(--primary-color);
                color: var(--primary-color);
            }
            .btn.btn-outline:hover:not(:disabled) { background: var(--primary-color); color: var(--btn-text-color); }
            .btn.btn-subtle {
                background: transparent; color: var(--text-color-muted); box-shadow: none; padding: 0.5rem 1rem;
            }
            .btn.btn-subtle:hover:not(:disabled) { background: var(--bg-color-elements); color: var(--text-color); }
            .section-title {
                margin-bottom: 1rem; color: var(--heading-color); display: flex;
                align-items: center; gap: 0.6rem; font-size: 1.1rem;
                font-weight: 600; border-bottom: 1px solid var(--border-color);
                padding-bottom: 0.6rem;
            }
            .section-title i { font-size: 1.1em; color: var(--icon-color); min-width: 20px; text-align: center; }
            .template-options, .sections-list-container, .export-options, .version-history { margin-bottom: 1.75rem; }
            .template-card {
                background-color: var(--bg-color-elements); border-radius: var(--border-radius-md);
                padding: 1rem 1.25rem; margin-bottom: 0.75rem; cursor: pointer;
                transition: all var(--transition-speed) ease; border: 1px solid transparent;
                position: relative; overflow: hidden;
            }
            .template-card:hover {
                transform: translateY(-3px); box-shadow: var(--shadow-md);
                border-color: var(--primary-color); background-color: var(--bg-color-main);
            }
            .template-card.active {
                border-color: var(--primary-color);
                background-color: color-mix(in srgb, var(--primary-color) 8%, var(--bg-color-main));
                box-shadow: 0 0 10px rgba(var(--shadow-color-rgb), 0.1);
            }
            .template-card h4 { margin-bottom: 0.3rem; color: var(--heading-color); font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
            .template-card h4 i { color: var(--icon-color); font-size: 1em; }
            .template-card p { font-size: 0.8rem; opacity: 0.8; color: var(--text-color-muted); }
            .sections-list {
                list-style: none; padding: 0; margin: 0; max-height: 400px;
                overflow-y: auto; padding-right: 10px;
            }
            .section-item {
                display: flex; align-items: center; justify-content: space-between;
                background-color: var(--bg-color-elements); padding: 0.7rem 1rem;
                margin-bottom: 0.5rem; border-radius: var(--border-radius-md);
                cursor: grab; transition: all var(--transition-speed) ease;
                border-left: 4px solid transparent; opacity: 1;
                box-shadow: var(--shadow-xs);
            }
            .section-item:hover {
                background-color: var(--bg-color-elements-hover);
                border-left-color: var(--secondary-color);
            }
            .section-item.active {
                background-color: color-mix(in srgb, var(--primary-color) 10%, var(--bg-color-main));
                border-left-color: var(--primary-color);
                box-shadow: inset 3px 0 8px rgba(var(--shadow-color-rgb), 0.08);
            }
            .section-item.dragging { opacity: 0.6; background: var(--secondary-color); transform: scale(1.02); box-shadow: var(--shadow-lg); cursor: grabbing; }
            .section-item[data-section="cover-page"], .section-item[data-section="references-section"] { cursor: default; }
            .section-item[draggable="false"] { cursor: default; }
            .section-item.hidden-section { opacity: 0.6; background-color: color-mix(in srgb, var(--secondary-color) 50%, transparent); border-left-color: var(--text-color-muted); }
            .section-item.hidden-section .section-item-name span.section-text { text-decoration: line-through; }
            .section-item-name { display: flex; align-items: center; gap: 0.6rem; font-weight: 500; overflow: hidden; font-size: 0.9rem; }
            .section-item-name i.visibility-toggle { font-size: 0.9em; cursor: pointer; opacity: 0.7; transition: opacity var(--transition-speed); color: var(--secondary-color); width: 18px; text-align: center; }
            .section-item-name i.placeholder-icon { opacity: 0; cursor: default; width: 18px; }
            .section-item-name i.visibility-toggle:hover { opacity: 1; color: var(--primary-color); }
            .section-item.hidden-section i.fa-eye { display: none; }
            .section-item:not(.hidden-section) i.fa-eye-slash { display: none; }
            .section-item-name i.section-icon { color: var(--icon-color); width: 20px; text-align: center; transition: transform var(--transition-speed) ease; font-size: 1em; }
            .section-item.active .section-item-name i.section-icon { transform: scale(1.1); }
            .section-item-name .section-letter { font-weight: 700; color: var(--primary-color); opacity: 0.8; min-width: 20px; font-size: 0.85em; }
            .section-item-name .section-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .section-item-name .tag { font-size: 0.7rem; color: white; background-color: var(--accent-color); padding: 0.1rem 0.4rem; border-radius: var(--border-radius-sm); margin-left: 0.4rem; opacity: 0.9; font-weight: 500; }
            .section-actions { display: flex; gap: 0.4rem; }
            .action-btn {
                background: none; border: none; color: var(--text-color-muted); cursor: pointer;
                opacity: 0.6; transition: all var(--transition-speed) ease; font-size: 0.9rem;
                padding: 0.2rem; display: flex; align-items: center; justify-content: center;
                width: 24px; height: 24px; border-radius: var(--border-radius-sm);
            }
            .action-btn:hover { opacity: 1; color: var(--primary-color); background-color: var(--bg-color-elements-hover); transform: scale(1.1); }
            .action-btn.remove-section:hover { color: var(--danger-color); }
            .main-content .section-title { font-size: 1.4rem;  gap: 0.75rem; }
            .main-content .section-title i { font-size: 1.1em; }
            .tab-container { margin-bottom: 1.5rem; }
            .tab-buttons { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: -1px; }
            .tab-btn {
                padding: 0.8rem 1.5rem; background: none; border: none;
                border-bottom: 3px solid transparent; color: var(--text-color-muted);
                cursor: pointer; opacity: 0.8; transition: all var(--transition-speed) ease;
                font-weight: 600; font-size: 0.9rem; margin-bottom: -1px; position: relative;
            }
            .tab-btn:hover { opacity: 1; background-color: var(--bg-color-elements); color: var(--text-color); }
            .tab-btn.active {
                opacity: 1; color: var(--primary-color); border-bottom-color: var(--primary-color);
            }
            .tab-content { display: none; padding: 1.75rem 0.25rem; border-top: 1px solid var(--border-color); margin-top: -1px; }
            .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
            .editor-area { border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background-color: var(--bg-color-main); margin-bottom: 1rem; box-shadow: var(--shadow-sm); }
            .editor-toolbar {
                display: flex; flex-wrap: wrap; gap: 0.3rem; padding: 0.6rem 0.8rem;
                background-color: var(--bg-color-sidebar); border-bottom: 1px solid var(--border-color);
                border-top-left-radius: var(--border-radius-md); border-top-right-radius: var(--border-radius-md);
            }
            .toolbar-btn {
                background: var(--bg-color-main); border: 1px solid var(--border-color);
                color: var(--text-color); cursor: pointer; opacity: 0.9;
                transition: all var(--transition-speed) ease; padding: 0.5rem 0.7rem;
                border-radius: var(--border-radius-sm); font-size: 0.85rem; min-width: 36px; height: 36px;
                display: inline-flex; align-items: center; justify-content: center;
            }
            .toolbar-btn:hover:not(:disabled) { opacity: 1; background-color: var(--bg-color-elements-hover); border-color: var(--border-color-strong); }
            .toolbar-btn.is-active { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--btn-text-color); }
            .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; }
            .toolbar-separator { width: 1px; background-color: var(--border-color); margin: 0.2rem 0.5rem; align-self: stretch; }
            .ProseMirror {
                padding: 1rem 1.5rem; min-height: 450px; outline: none;
                font-size: 1rem; color: var(--text-color); line-height: 1.7;
                max-width: 100%;
                overflow-wrap: break-word;
                word-wrap: break-word;
                word-break: break-word;
                hyphens: auto;
            }
            .ProseMirror:focus { outline: none; }
            .ProseMirror p.is-editor-empty:first-child::before {
                content: attr(data-placeholder);
                float: left;
                color: var(--placeholder-color);
                pointer-events: none;
                height: 0;
                opacity: 0.8;
            }
            .ProseMirror h1, .ProseMirror h2, .ProseMirror h3, .ProseMirror h4 { margin-top: 1.5em; margin-bottom: 0.8em; color: var(--heading-color); font-weight: 700; line-height: 1.3; }
            .ProseMirror h1 { font-size: 1.8em; } .ProseMirror h2 { font-size: 1.5em; } .ProseMirror h3 { font-size: 1.25em; } .ProseMirror h4 { font-size: 1.1em; }
            .ProseMirror p { margin-bottom: 1em; }
            .ProseMirror ul, .ProseMirror ol { margin-left: 1.5em; margin-bottom: 1em; padding-left: 1em; }
            .ProseMirror li { margin-bottom: 0.4em; }
            .ProseMirror blockquote { border-left: 3px solid var(--border-color-strong); padding-left: 1em; margin: 1em 0; font-style: italic; color: var(--text-color-muted); }
            .ProseMirror table { width: 100%; border-collapse: collapse; margin: 1.5em 0; border: 1px solid var(--border-color-strong); table-layout: fixed; }
            .ProseMirror th, .ProseMirror td { border: 1px solid var(--border-color); padding: 0.6rem 0.8rem; text-align: left; vertical-align: top; min-width: 50px; position: relative; }
            .ProseMirror th { background-color: var(--bg-color-elements); font-weight: bold; }
            .ProseMirror .selectedCell:after { z-index: 2; position: absolute; content: ""; left: 0; right: 0; top: 0; bottom: 0; background: rgba(var(--shadow-color-rgb), 0.15); pointer-events: none; }
            .ProseMirror .column-resize-handle { position: absolute; right: -2px; top: 0; bottom: 0; width: 4px; z-index: 20; background-color: #adf; pointer-events: none; }
            .ProseMirror img { max-width: 90%; height: auto; border-radius: var(--border-radius-md); margin: 1em auto; display: block; box-shadow: var(--shadow-sm); cursor: pointer; }
            .ProseMirror img.ProseMirror-selectednode { outline: 3px solid var(--primary-color); }
            .ProseMirror pre { background: var(--code-bg); color: var(--code-text); font-family: 'Courier New', Courier, monospace; padding: 1em; border-radius: var(--border-radius-sm); margin: 1.5em 0; overflow-x: auto; }
            .ProseMirror code { background: var(--code-bg); padding: 0.2em 0.4em; border-radius: var(--border-radius-sm); font-size: 0.9em; }
            .ProseMirror pre code { background: none; padding: 0; border-radius: 0; font-size: inherit; }
            .ProseMirror a { color: var(--link-color); text-decoration: underline; cursor: pointer; }
            .ProseMirror a:hover { color: color-mix(in srgb, var(--link-color) 80%, var(--text-color) 20%); }
            .markdown-editor-area { display: flex; gap: 1rem; }
            .markdown-editor-area textarea, .markdown-preview-area {
                flex: 1; min-height: 450px; border: 1px solid var(--border-color);
                border-radius: var(--border-radius-md); padding: 1rem 1.5rem;
                background-color: var(--bg-color-main); font-size: 0.95rem;
                line-height: 1.6;
            }
            .markdown-editor-area textarea { font-family: 'Courier New', Courier, monospace; resize: vertical; }
            .markdown-preview-area { background-color: var(--bg-color-elements); overflow-y: auto; }
            .markdown-preview-area h1, .markdown-preview-area h2, .markdown-preview-area h3, .markdown-preview-area h4 { margin-top: 1.5em; margin-bottom: 0.8em; color: var(--heading-color); font-weight: 700; line-height: 1.3; }
            .markdown-preview-area h1 { font-size: 1.8em; } .markdown-preview-area h2 { font-size: 1.5em; } .markdown-preview-area h3 { font-size: 1.25em; } .markdown-preview-area h4 { font-size: 1.1em; }
            .markdown-preview-area p { margin-bottom: 1em; }
            .markdown-preview-area ul, .markdown-preview-area ol { margin-left: 1.5em; margin-bottom: 1em; padding-left: 1em; }
            .markdown-preview-area li { margin-bottom: 0.4em; }
            .markdown-preview-area blockquote { border-left: 3px solid var(--border-color-strong); padding-left: 1em; margin: 1em 0; font-style: italic; color: var(--text-color-muted); }
            .markdown-preview-area table { width: 100%; border-collapse: collapse; margin: 1.5em 0; border: 1px solid var(--border-color-strong); }
            .markdown-preview-area th, .markdown-preview-area td { border: 1px solid var(--border-color); padding: 0.6rem 0.8rem; text-align: left; }
            .markdown-preview-area th { background-color: var(--bg-color-elements-hover); font-weight: bold; }
            .markdown-preview-area img { max-width: 90%; height: auto; border-radius: var(--border-radius-md); margin: 1em auto; display: block; box-shadow: var(--shadow-sm); }
            .markdown-preview-area pre { margin: 1.5em 0; }
            .markdown-preview-area code:not(pre > code) { background: var(--code-bg); color: var(--code-text); padding: 0.2em 0.4em; border-radius: var(--border-radius-sm); font-size: 0.9em; }
            .markdown-preview-area a { color: var(--link-color); text-decoration: underline; }
            .editor-status-bar {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.5rem 0.25rem; font-size: 0.8rem; color: var(--text-color-muted);
                opacity: 0.9; margin-top: -0.5rem;
            }
            .save-status { display: inline-flex; align-items: center; gap: 0.4rem; transition: opacity 0.4s ease, color 0.4s ease; opacity: 0; min-width: 120px; text-align: right; justify-content: flex-end; }
            .save-status.visible { opacity: 1; }
            .save-status i { margin-right: 0.2em; transition: transform 0.4s ease; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .save-status.saving i { animation: spin 1s linear infinite; }
            .save-status.saved { color: var(--success-color); }
            .save-status.unsaved { color: var(--warning-color); }
            .save-status.error { color: var(--danger-color); }
            #references-list { margin-top: 1rem; }
            .reference-item {
                background: var(--bg-color-elements); padding: 1rem; border-radius: var(--border-radius-md);
                margin-bottom: 0.75rem; border: 1px solid var(--border-color);
                display: flex; justify-content: space-between; align-items: flex-start;
            }
            .reference-details { flex-grow: 1; margin-right: 1rem; font-size: 0.9rem; }
            .reference-details strong { color: var(--heading-color); }
            .reference-actions .btn { width: auto; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
            .preview-modal {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: var(--modal-backdrop-color); backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px); z-index: 1000; display: none;
                align-items: flex-start;  justify-content: center;
                overflow-y: auto; padding: 5vh 3vw; animation: fadeIn 0.3s ease;
            }
            .preview-modal.show { display: flex; }
            .preview-content-area {
                background-color: #ffffff; color: #111;
                font-family: 'Times New Roman', Times, serif;
                line-height: 1.5; font-size: 12pt;
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto; padding: 20mm 18mm;
                box-shadow: 0 0 30px rgba(0,0,0,0.3); border-radius: 3px;
                position: relative; overflow: visible;
            }
            .preview-content-area h1, .preview-content-area h2, .preview-content-area h3, .preview-content-area h4, .preview-content-area h5, .preview-content-area h6 {
                font-family: 'Times New Roman', Times, serif; font-weight: bold; color: #000;
                margin-top: 1cm; margin-bottom: 0.5cm; line-height: 1.3;
                page-break-after: avoid; page-break-inside: avoid;
            }
            .preview-content-area h1 { font-size: 20pt; text-align: center; border-bottom: none; }
            .preview-content-area h2, .preview-content-area .report-section-title { font-size: 16pt; border-bottom: 1px solid #aaa; padding-bottom: 0.2cm; margin-top: 1.5cm; margin-bottom: 0.7cm; }
            .preview-content-area h3 { font-size: 14pt; }
            .preview-content-area h4 { font-size: 12pt; font-style: italic; }
            .preview-content-area p { margin-bottom: 0.4cm; text-align: justify; color: #000; }
            .preview-content-area ul, .preview-content-area ol { margin-left: 0.8cm; margin-bottom: 0.4cm; padding-left: 0.5cm; }
            .preview-content-area li { margin-bottom: 0.2cm; }
            .preview-content-area table.report-table { width: 100%; border-collapse: collapse; margin: 1cm auto; font-size: 10pt; border: 1px solid #888; page-break-inside: avoid; }
            .preview-content-area table.report-table th, .preview-content-area table.report-table td { border: 1px solid #aaa; padding: 0.25cm 0.35cm; text-align: left; vertical-align: top; }
            .preview-content-area table.report-table th { background-color: #e8e8e8; font-weight: bold; color: #000; }
            .preview-content-area img { max-width: 90%; height: auto; display: block; margin: 1cm auto; border: 1px solid #ccc; page-break-inside: avoid; }
            .preview-content-area .report-image-caption { font-style: italic; color: #444; margin-top: 0.3cm; margin-bottom: 0.7cm; text-align: center; font-size: 10pt; }
            .preview-content-area blockquote { border-left: 3px solid #ccc; padding-left: 1.5em; margin: 0.5cm 0; font-style: italic; color: #333; }
            .preview-content-area a { color: #0000EE; text-decoration: underline; }
            .preview-content-area .report-section { margin-bottom: 0.5cm; page-break-before: auto; }
            .preview-content-area .cover-page {
                text-align: center; min-height: calc(297mm - 40mm);
                display: flex; flex-direction: column; justify-content: space-between;
                align-items: center; position: relative; page-break-after: always;
                border: none; padding: 0; margin: -20mm -18mm;
                width: 210mm;
            }
            .preview-content-area .cover-page-content { padding: 20mm 18mm; width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; justify-content: space-between; }
            .preview-content-area .cover-page-top { margin-top: 1cm; }
            .preview-content-area .cover-page-middle { margin-top: 3cm; margin-bottom: 3cm; }
            .preview-content-area .cover-page-bottom { margin-bottom: 1cm; width: 80%; }
            .preview-content-area .institution-logo { max-width: 120px; max-height: 100px; height: auto; margin-bottom: 1cm; }
            .preview-content-area .report-title { font-size: 24pt; font-weight: bold; margin-bottom: 0.5cm; color: #000; border-bottom: none; }
            .preview-content-area .report-subtitle { font-size: 18pt; margin-bottom: 2cm; color: #333; }
            .preview-content-area .author-info { font-size: 12pt; line-height: 1.6; }
            .preview-content-area .author-name { font-weight: bold; margin-bottom: 0.3cm; font-size: 14pt; }
            .preview-content-area .submission-info { text-align: center; font-size: 11pt; color: #333; line-height: 1.5; }
            .preview-content-area .toc-title { font-size: 16pt; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 0.3cm; margin-bottom: 0.8cm; text-align: center; }
            .preview-content-area .toc-list { list-style: none; padding-left: 0; margin: 0 1cm; }
            .preview-content-area .toc-item { display: flex; justify-content: space-between; padding: 0.2cm 0; border-bottom: 1px dotted #ddd; }
            .preview-content-area .toc-item a { text-decoration: none; color: #000; }
            .preview-content-area .toc-item a:hover { text-decoration: underline; }
            .preview-content-area .toc-item .page-num { font-style: italic; color: #555; }
            .preview-content-area .page-number { position: absolute; bottom: 10mm; right: 18mm; font-size: 10pt; color: #555; }
            .preview-close-btn {
                position: fixed; top: 20px; right: 25px;
                background: rgba(50, 50, 50, 0.8); color: #fff; border: none;
                border-radius: 50%; width: 45px; height: 45px; font-size: 1.5rem;
                cursor: pointer; z-index: 1002; display: flex; align-items: center;
                justify-content: center; line-height: 1; padding-bottom: 3px;
                transition: background 0.3s ease, transform 0.3s ease; box-shadow: var(--shadow-md);
            }
            .preview-close-btn:hover { background: rgba(0, 0, 0, 0.9); transform: scale(1.1); }
            #notification-area { position: fixed; bottom: 25px; right: 25px; z-index: 1005; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
            .notification {
                background-color: var(--bg-color-main); color: var(--text-color);
                padding: 0.8rem 1.5rem; border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg); z-index: 1001; opacity: 0;
                transform: translateX(100%); transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                border-left: 5px solid var(--primary-color); display: flex; align-items: center;
                gap: 0.8rem; min-width: 320px; max-width: 400px; pointer-events: all;
                font-size: 0.9rem;
            }
            .notification.show { opacity: 1; transform: translateX(0); }
            .notification.dismissing { opacity: 0; transform: scale(0.95); }
            .notification i { font-size: 1.2em; min-width: 20px; text-align: center; }
            .notification.success { border-left-color: var(--success-color); } .notification.success i { color: var(--success-color); }
            .notification.error { border-left-color: var(--danger-color); } .notification.error i { color: var(--danger-color); }
            .notification.warning { border-left-color: var(--warning-color); } .notification.warning i { color: var(--warning-color); }
            .notification.info { border-left-color: var(--info-color); } .notification.info i { color: var(--info-color); }
            .loading-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px);
                z-index: 1010; display: none; align-items: center; justify-content: center;
                flex-direction: column; gap: 1rem; color: white;
            }
            .loading-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
            .loader {
                border: 6px solid var(--secondary-color); border-top: 6px solid var(--primary-color);
                border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
            }
            .loading-message { font-size: 1rem; font-weight: 500; }
            .modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: var(--modal-backdrop-color); z-index: 1003;
                display: none; align-items: center; justify-content: center;
                backdrop-filter: blur(4px); padding: 1rem;
            }
            .modal-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
            .modal-content {
                background-color: var(--modal-bg-color); padding: 1.75rem 2rem;
                border-radius: var(--border-radius-lg); box-shadow: var(--shadow-xl);
                max-width: 550px; width: 95%; animation: zoomIn 0.3s ease-out;
                max-height: 90vh; overflow-y: auto;
            }
            .modal-title {
                color: var(--heading-color); margin-bottom: 1.25rem; font-size: 1.25rem;
                font-weight: 700; border-bottom: 1px solid var(--border-color);
                padding-bottom: 0.8rem; display: flex; align-items: center; gap: 0.75rem;
            }
            .modal-title i { color: var(--primary-color); }
            .modal-buttons { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
            .modal-buttons .btn { width: auto; min-width: 110px; }
            .version-history-list { max-height: 200px; overflow-y: auto; margin-top: 0.5rem; }
            .version-item {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.6rem 0.8rem; border-radius: var(--border-radius-sm);
                margin-bottom: 0.5rem; background-color: var(--bg-color-elements);
                font-size: 0.85rem;
            }
            .version-item span { color: var(--text-color-muted); }
            .version-item .btn { width: auto; padding: 0.3rem 0.7rem; font-size: 0.75rem; }
            .hidden { display: none !important; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            @media print {
                body { background: #fff !important; color: #000 !important; font-size: 11pt; }
                .sidebar, .header-controls, .main-content .tab-container, .main-content .form-buttons, .editor-status-bar, #notification-area, .loading-overlay, .modal-overlay, .preview-close-btn, #add-section-btn, .export-options, .version-history {
                    display: none !important;
                }
                .container { max-width: 100%; margin: 0; padding: 0; }
                .app-layout { display: block; }
                .main-content { padding: 0; border: none; box-shadow: none; background: transparent; }
                .preview-modal { position: static; display: block; background: none; backdrop-filter: none; padding: 0; overflow: visible; }
                .preview-content-area {
                    width: 100%; min-height: auto; box-shadow: none; border-radius: 0;
                    padding: 0; margin: 0; font-size: 11pt;
                    font-family: 'Times New Roman', Times, serif;
                }
                .preview-content-area h1, .preview-content-area h2, .preview-content-area h3, .preview-content-area h4 { margin-top: 0.8cm; margin-bottom: 0.4cm; }
                .preview-content-area h2, .preview-content-area .report-section-title { font-size: 14pt; margin-top: 1cm; }
                .preview-content-area p { margin-bottom: 0.35cm; }
                .preview-content-area table.report-table { font-size: 9pt; margin: 0.7cm auto; }
                .preview-content-area table.report-table th, .preview-content-area table.report-table td { padding: 0.2cm 0.3cm; }
                .preview-content-area img { max-width: 85%; margin: 0.7cm auto; }
                .preview-content-area .cover-page { min-height: 90vh;  margin: 0; padding: 1cm; }
                .preview-content-area .page-number { display: block; }
                a { color: #000; text-decoration: none; }
                blockquote { color: #333; }
                pre, code { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #ccc; white-space: pre-wrap; word-wrap: break-word; }
            }
        </style>
    </head>
    <body class="theme-light">
        <div class="container">
            <header>
                <div class="header-controls">
                    <button
                        id="theme-toggle-btn"
                        class="control-btn"
                        title="Toggle Theme"
                        aria-label="Toggle Theme"
                    >
                        <i class="fas fa-sun"></i>
                    </button>
                    <button
                        id="focus-toggle-btn"
                        class="control-btn"
                        title="Toggle Focus Mode"
                        aria-label="Toggle Focus Mode"
                    >
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
                <h1 class="main-title">Kholipha's Reports</h1>
                <p class="subtitle">Advanced Academic Report Creator</p>
            </header>
            <div class="app-layout" id="app-layout">
                <aside class="sidebar">
                    <div class="template-options">
                        <h3 class="section-title">
                            <i class="fas fa-scroll"></i> Report Templates
                        </h3>
                        <div
                            class="template-card"
                            data-template="lab-report"
                            role="button"
                            tabindex="0"
                        >
                            <h4>
                                <i class="fas fa-flask-vial"></i> Lab Report
                            </h4>
                            <p>
                                Structured scientific report with standard
                                sections.
                            </p>
                        </div>
                        <div
                            class="template-card"
                            data-template="assignment"
                            role="button"
                            tabindex="0"
                        >
                            <h4>
                                <i class="fas fa-file-pen"></i> Assignment
                                Report
                            </h4>
                            <p>Flexible format for academic assignments.</p>
                        </div>
                        <div
                            class="template-card"
                            data-template="research-paper"
                            role="button"
                            tabindex="0"
                        >
                            <h4>
                                <i class="fas fa-book-open-reader"></i> Research
                                Paper
                            </h4>
                            <p>Formal layout for research publication.</p>
                        </div>
                        <div
                            class="template-card"
                            data-template="thesis-chapter"
                            role="button"
                            tabindex="0"
                        >
                            <h4>
                                <i class="fas fa-graduation-cap"></i> Thesis
                                Chapter
                            </h4>
                            <p>Comprehensive structure for thesis sections.</p>
                        </div>
                    </div>
                    <div class="sections-list-container">
                        <h3 class="section-title">
                            <i class="fas fa-stream"></i> Report Structure
                        </h3>
                        <div
                            class="sections-list"
                            id="sections-list"
                            aria-live="polite"
                        ></div>
                    </div>
                    <button
                        class="btn btn-secondary"
                        id="add-section-btn"
                        style="margin-bottom: 1.75rem"
                    >
                        <i class="fas fa-plus-circle"></i> Add Custom Section
                    </button>
                    <div class="version-history">
                        <h3 class="section-title">
                            <i class="fas fa-history"></i> Version History
                        </h3>
                        <button
                            class="btn btn-subtle"
                            id="save-version-btn"
                            style="width: auto; margin-bottom: 0.5rem"
                        >
                            <i class="fas fa-save"></i> Save Current Version
                        </button>
                        <div
                            class="version-history-list"
                            id="version-history-list"
                        ></div>
                    </div>
                    <div class="export-options">
                        <h3 class="section-title">
                            <i class="fas fa-cloud-download-alt"></i> Export
                            Options
                        </h3>
                        <button
                            class="btn btn-outline"
                            id="preview-btn"
                            style="margin-bottom: 0.75rem"
                        >
                            <i class="fas fa-eye"></i> Live Preview (A4)
                        </button>
                        <button
                            class="btn"
                            id="download-pdf-btn"
                            style="margin-bottom: 0.75rem"
                        >
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                        <button
                            class="btn btn-secondary"
                            id="download-md-btn"
                            style="margin-bottom: 0.75rem"
                        >
                            <i class="fab fa-markdown"></i> Download Markdown
                        </button>
                        <button
                            class="btn btn-secondary"
                            id="download-html-btn"
                            style="margin-bottom: 0.75rem"
                        >
                            <i class="fas fa-code"></i> Download HTML
                        </button>
                        <button class="btn btn-danger" id="clear-storage-btn">
                            <i class="fas fa-trash-alt"></i> Clear All Saved
                            Data
                        </button>
                    </div>
                </aside>
                <main class="main-content">
                    <div class="editor-container">
                        <h2 class="section-title current-section-title">
                            <i class="fas fa-edit"></i> <span>Loading...</span>
                        </h2>
                        <div class="tab-container">
                            <div class="tab-buttons">
                                <button
                                    class="tab-btn"
                                    data-tab="form"
                                    role="tab"
                                    aria-controls="form-tab"
                                >
                                    <i class="fas fa-address-card"></i> Cover
                                    Page Details
                                </button>
                                <button
                                    class="tab-btn"
                                    data-tab="editor"
                                    role="tab"
                                    aria-controls="editor-tab"
                                >
                                    <i class="fas fa-pen-alt"></i> Section
                                    Content
                                </button>
                                <button
                                    class="tab-btn"
                                    data-tab="references"
                                    role="tab"
                                    aria-controls="references-tab"
                                >
                                    <i class="fas fa-book"></i> References
                                </button>
                            </div>
                            <div
                                class="tab-content"
                                id="form-tab"
                                role="tabpanel"
                                aria-labelledby="form-tab-btn"
                            >
                                <div class="form-group">
                                    <label for="cover-institution-name"
                                        >Institution Name</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-institution-name"
                                        class="form-control"
                                        placeholder="e.g., Quantum Dynamics University"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Full name of your university or college."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-logo-url"
                                        >Institution Logo URL (Optional)</label
                                    >
                                    <input
                                        type="url"
                                        id="cover-logo-url"
                                        class="form-control"
                                        placeholder="https://example.com/logo.png"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Direct link (URL) to the institution's logo image (e.g., ending in .png, .jpg). Ensure it's publicly accessible."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-report-title"
                                        >Report Title</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-report-title"
                                        class="form-control"
                                        placeholder="e.g., Analysis of Quantum Entanglement"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Main title of your report. Be clear and concise."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-report-subtitle"
                                        >Subtitle (Optional)</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-report-subtitle"
                                        class="form-control"
                                        placeholder="e.g., A Comprehensive Study"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="An optional secondary title or description."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-author-name"
                                        >Student Name</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-author-name"
                                        class="form-control"
                                        placeholder="e.g., Dr. Evelyn Reed"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Your full name as you want it to appear."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-student-id"
                                        >Student ID</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-student-id"
                                        class="form-control"
                                        placeholder="e.g., SC98765"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Your unique student identification number."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-department"
                                        >Department</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-department"
                                        class="form-control"
                                        placeholder="e.g., Physics"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Your academic department (e.g., Physics, Computer Science)."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-semester">Semester</label>
                                    <input
                                        type="text"
                                        id="cover-semester"
                                        class="form-control"
                                        placeholder="e.g., Fall 2024"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="The current academic semester (e.g., Fall 2024, Spring 2025)."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-course-name"
                                        >Course Name</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-course-name"
                                        class="form-control"
                                        placeholder="e.g., Advanced Theoretical Physics"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="The full name of the course this report is for."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-course-code"
                                        >Course ID / Code</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-course-code"
                                        class="form-control"
                                        placeholder="e.g., PHYS-701"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="The official course code (e.g., PHYS-701, CS101)."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-lab-section"
                                        >Lab Section (If applicable)</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-lab-section"
                                        class="form-control"
                                        placeholder="e.g., Section B"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Your specific lab section, if relevant (e.g., Section B, L01)."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-instructor-name"
                                        >Instructor Name</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-instructor-name"
                                        class="form-control"
                                        placeholder="e.g., Prof. Alistair Finch"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Full name of the course instructor or supervisor."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-instructor-designation"
                                        >Instructor Designation</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-instructor-designation"
                                        class="form-control"
                                        placeholder="e.g., Professor"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Instructor's title (e.g., Professor, Dr., Teaching Assistant)."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-instructor-department"
                                        >Instructor Department</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-instructor-department"
                                        class="form-control"
                                        placeholder="e.g., Department of Physics"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Department the instructor belongs to."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-experiment-date"
                                        >Date of Experiment (If
                                        applicable)</label
                                    >
                                    <input
                                        type="date"
                                        id="cover-experiment-date"
                                        class="form-control"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Date when the experimental work was performed."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-submission-date"
                                        >Submission Date</label
                                    >
                                    <input
                                        type="date"
                                        id="cover-submission-date"
                                        class="form-control"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="The date you are submitting the report."
                                    ></i>
                                </div>
                                <div class="form-group">
                                    <label for="cover-assignment-number"
                                        >Assignment/Project Number (If
                                        applicable)</label
                                    >
                                    <input
                                        type="text"
                                        id="cover-assignment-number"
                                        class="form-control"
                                        placeholder="e.g., Project 3"
                                    />
                                    <i
                                        class="fas fa-info-circle tooltip-icon"
                                        title="Specific number or identifier for this assignment."
                                    ></i>
                                </div>
                            </div>
                            <div
                                class="tab-content"
                                id="editor-tab"
                                role="tabpanel"
                                aria-labelledby="editor-tab-btn"
                            >
                                <div
                                    class="editor-area"
                                    id="tinymce-editor-area"
                                >
                                    <textarea id="editor-tinymce"></textarea>
                                </div>
                                <div
                                    class="editor-status-bar"
                                    id="editor-status-bar"
                                >
                                    <span id="word-count">Words: 0</span>
                                    <span
                                        class="save-status"
                                        id="save-status"
                                        aria-live="polite"
                                    >
                                        <i class="fas fa-check-circle"></i>
                                        <span>Saved</span>
                                    </span>
                                </div>
                                <button
                                    class="btn"
                                    id="save-section-btn"
                                    style="width: auto"
                                >
                                    <i class="fas fa-save"></i> Save Current
                                    Section
                                </button>
                                <button
                                    class="btn btn-secondary"
                                    id="toggle-editor-mode-btn"
                                    title="Toggle Editor Mode (Rich Text / Markdown)"
                                    style="width: auto; margin-left: 0.5rem"
                                >
                                    <i class="fas fa-code"></i>
                                    <span class="mode-indicator"
                                        >(Rich Text)</span
                                    >
                                </button>
                                <div
                                    class="markdown-editor-area hidden"
                                    id="markdown-editor-area"
                                    style="margin-top: 1rem"
                                >
                                    <textarea
                                        id="editor-markdown"
                                        placeholder="Enter Markdown here..."
                                        spellcheck="false"
                                        aria-label="Markdown Editor"
                                    ></textarea>
                                    <div
                                        class="markdown-preview-area"
                                        id="markdown-preview-area"
                                        aria-label="Markdown Preview"
                                    ></div>
                                </div>
                            </div>
                            <div
                                class="tab-content"
                                id="references-tab"
                                role="tabpanel"
                                aria-labelledby="references-tab-btn"
                            >
                                <h3
                                    class="section-title"
                                    style="border: none; margin-bottom: 1rem"
                                >
                                    <i class="fas fa-book"></i> Manage
                                    References
                                </h3>
                                <div
                                    id="reference-form"
                                    style="
                                        background: var(--bg-color-elements);
                                        padding: 1.5rem;
                                        border-radius: var(--border-radius-md);
                                        margin-bottom: 1.5rem;
                                    "
                                >
                                    <h4
                                        style="
                                            margin-bottom: 1rem;
                                            font-weight: 600;
                                        "
                                    >
                                        Add New Reference
                                    </h4>
                                    <div class="form-group">
                                        <label for="ref-type"
                                            >Reference Type</label
                                        >
                                        <select
                                            id="ref-type"
                                            class="form-control"
                                        >
                                            <option value="journal">
                                                Journal Article
                                            </option>
                                            <option value="book">Book</option>
                                            <option value="website">
                                                Website
                                            </option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-key"
                                            >Citation Key (e.g.,
                                            Smith2023)</label
                                        >
                                        <input
                                            type="text"
                                            id="ref-key"
                                            class="form-control"
                                            placeholder="Unique key for in-text citation"
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-authors"
                                            >Author(s)</label
                                        >
                                        <input
                                            type="text"
                                            id="ref-authors"
                                            class="form-control"
                                            placeholder="e.g., Smith, J.; Doe, A. B."
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-year">Year</label>
                                        <input
                                            type="number"
                                            id="ref-year"
                                            class="form-control"
                                            placeholder="e.g., 2023"
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="ref-title">Title</label>
                                        <input
                                            type="text"
                                            id="ref-title"
                                            class="form-control"
                                            placeholder="Title of article, book, or page"
                                        />
                                    </div>
                                    <div
                                        class="form-group ref-field journal book"
                                    >
                                        <label for="ref-source"
                                            >Journal Name / Book
                                            Publisher</label
                                        >
                                        <input
                                            type="text"
                                            id="ref-source"
                                            class="form-control"
                                        />
                                    </div>
                                    <div class="form-group ref-field journal">
                                        <label for="ref-volume"
                                            >Volume (Issue)</label
                                        >
                                        <input
                                            type="text"
                                            id="ref-volume"
                                            class="form-control"
                                            placeholder="e.g., 12(3)"
                                        />
                                    </div>
                                    <div
                                        class="form-group ref-field journal book"
                                    >
                                        <label for="ref-pages"
                                            >Pages / DOI</label
                                        >
                                        <input
                                            type="text"
                                            id="ref-pages"
                                            class="form-control"
                                            placeholder="e.g., 123-145 or DOI link"
                                        />
                                    </div>
                                    <div class="form-group ref-field website">
                                        <label for="ref-url">URL</label>
                                        <input
                                            type="url"
                                            id="ref-url"
                                            class="form-control"
                                            placeholder="https://example.com"
                                        />
                                    </div>
                                    <div class="form-group ref-field website">
                                        <label for="ref-access-date"
                                            >Accessed Date</label
                                        >
                                        <input
                                            type="date"
                                            id="ref-access-date"
                                            class="form-control"
                                        />
                                    </div>
                                    <div class="form-group ref-field other">
                                        <label for="ref-details"
                                            >Other Details</label
                                        >
                                        <textarea
                                            id="ref-details"
                                            class="form-control"
                                            rows="3"
                                            placeholder="Enter any other relevant citation information"
                                        ></textarea>
                                    </div>
                                    <button class="btn" id="add-reference-btn">
                                        <i class="fas fa-plus"></i> Add
                                        Reference
                                    </button>
                                    <button
                                        class="btn btn-secondary hidden"
                                        id="update-reference-btn"
                                        style="margin-left: 0.5rem"
                                    >
                                        <i class="fas fa-save"></i> Update
                                        Reference
                                    </button>
                                    <button
                                        class="btn btn-subtle hidden"
                                        id="cancel-edit-reference-btn"
                                        style="margin-left: 0.5rem"
                                    >
                                        Cancel Edit
                                    </button>
                                </div>
                                <div id="references-list"></div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <div
            class="preview-modal"
            id="preview-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="preview-title"
        >
            <button
                class="preview-close-btn"
                id="preview-close-btn"
                title="Close Preview"
                aria-label="Close Preview"
            >
                ×
            </button>
            <div class="preview-content-area" id="preview-content-area"></div>
        </div>
        <div
            class="modal-overlay"
            id="add-section-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="add-section-title"
        >
            <div class="modal-content">
                <h3 class="modal-title" id="add-section-title">
                    <i class="fas fa-plus-circle"></i> Add Custom Section
                </h3>
                <div class="form-group" style="margin-top: 1.5rem">
                    <label for="new-section-name">Section Name</label>
                    <input
                        type="text"
                        id="new-section-name"
                        class="form-control"
                        placeholder="e.g., Further Analysis"
                        required
                    />
                </div>
                <div class="modal-buttons">
                    <button
                        class="btn btn-secondary"
                        id="cancel-add-section-btn"
                    >
                        Cancel
                    </button>
                    <button class="btn" id="confirm-add-section-btn">
                        Add Section
                    </button>
                </div>
            </div>
        </div>
        <div
            class="modal-overlay"
            id="restore-version-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="restore-version-title"
        >
            <div class="modal-content">
                <h3 class="modal-title" id="restore-version-title">
                    <i class="fas fa-undo"></i> Restore Version
                </h3>
                <p>
                    Are you sure you want to restore the version saved on
                    <strong id="restore-version-timestamp"></strong>?
                </p>
                <p style="color: var(--warning-color); font-weight: bold">
                    This will overwrite your current work. This action cannot be
                    undone.
                </p>
                <div class="modal-buttons">
                    <button
                        class="btn btn-secondary"
                        id="cancel-restore-version-btn"
                    >
                        Cancel
                    </button>
                    <button
                        class="btn btn-danger"
                        id="confirm-restore-version-btn"
                    >
                        Restore Version
                    </button>
                </div>
            </div>
        </div>
        <div id="notification-area"></div>
        <div class="loading-overlay" id="loading-overlay" aria-live="assertive">
            <div class="loader"></div>
            <div class="loading-message" id="loading-message">Loading...</div>
        </div>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script
            src="https://cdn.tiny.cloud/1/kck5o3812gjl4zconw5cwdx3ok1rzhtap0od4i871yx4ye88/tinymce/6/tinymce.min.js"
            referrerpolicy="origin"
        ></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
            });
        </script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"
            integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script>
                document.addEventListener('DOMContentLoaded', () => {
                const themeToggleBtn = document.getElementById('theme-toggle-btn');
                const focusToggleBtn = document.getElementById('focus-toggle-btn');
                const appLayout = document.getElementById('app-layout');
                const templateCards = document.querySelectorAll('.template-card');
                const sectionsList = document.getElementById('sections-list');
                const addSectionBtn = document.getElementById('add-section-btn');
                const saveVersionBtn = document.getElementById('save-version-btn');
                const versionHistoryList = document.getElementById('version-history-list');
                const previewBtn = document.getElementById('preview-btn');
                const downloadPdfBtn = document.getElementById('download-pdf-btn');
                const downloadMdBtn = document.getElementById('download-md-btn');
                const downloadHtmlBtn = document.getElementById('download-html-btn');
                const clearStorageBtn = document.getElementById('clear-storage-btn');
                const currentSectionTitle = document.querySelector('.current-section-title span');
                const currentSectionIcon = document.querySelector('.current-section-title i');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                const coverPageForm = document.getElementById('form-tab');
                const editorTab = document.getElementById('editor-tab');
                const referencesTab = document.getElementById('references-tab');
                const tinymceEditorArea = document.getElementById('tinymce-editor-area'); 
                const tinymceEditorTextarea = document.getElementById('editor-tinymce'); 
                const wordCountEl = document.getElementById('word-count');
                const saveStatusEl = document.getElementById('save-status');
                const saveSectionBtn = document.getElementById('save-section-btn');
                const toggleEditorModeBtn = document.getElementById('toggle-editor-mode-btn');
                const markdownEditorArea = document.getElementById('markdown-editor-area');
                const markdownEditor = document.getElementById('editor-markdown');
                const markdownPreview = document.getElementById('markdown-preview-area');
                const refTypeSelect = document.getElementById('ref-type');
                const refForm = document.getElementById('reference-form');
                const refFields = refForm.querySelectorAll('.ref-field');
                const addReferenceBtn = document.getElementById('add-reference-btn');
                const updateReferenceBtn = document.getElementById('update-reference-btn');
                const cancelEditReferenceBtn = document.getElementById('cancel-edit-reference-btn');
                const referencesListContainer = document.getElementById('references-list');
                const previewModal = document.getElementById('preview-modal');
                const previewContentArea = document.getElementById('preview-content-area');
                const previewCloseBtn = document.getElementById('preview-close-btn');
                const addSectionModal = document.getElementById('add-section-modal');
                const newSectionNameInput = document.getElementById('new-section-name');
                const confirmAddSectionBtn = document.getElementById('confirm-add-section-btn');
                const cancelAddSectionBtn = document.getElementById('cancel-add-section-btn');
                const restoreVersionModal = document.getElementById('restore-version-modal');
                const restoreVersionTimestampEl = document.getElementById('restore-version-timestamp');
                const confirmRestoreVersionBtn = document.getElementById('confirm-restore-version-btn');
                const cancelRestoreVersionBtn = document.getElementById('cancel-restore-version-btn');
                const notificationArea = document.getElementById('notification-area');
                const loadingOverlay = document.getElementById('loading-overlay');
                const loadingMessage = document.getElementById('loading-message');
                let turndownService = null;
                let reportData = {};
                let activeSectionId = null;
                let currentTheme = 'light';
                let isFocusMode = false;
                let editorMode = 'tinymce'; 
                let saveTimeout = null;
                let currentEditingRefId = null;
                let versionToRestore = null;
                let dragSrcElement = null;
                const defaultSections = {
                    'lab-report': [
                        { id: 'cover-page', name: 'Cover Page', icon: 'fa-address-card', canRemove: false, canHide: false, canMove: false },
                        { id: 'abstract', name: 'Abstract', icon: 'fa-file-alt', canRemove: true, canHide: true, canMove: true },
                        { id: 'introduction', name: 'Introduction', icon: 'fa-lightbulb', canRemove: true, canHide: true, canMove: true },
                        { id: 'methods', name: 'Methods & Materials', icon: 'fa-cogs', canRemove: true, canHide: true, canMove: true },
                        { id: 'results', name: 'Results', icon: 'fa-chart-bar', canRemove: true, canHide: true, canMove: true },
                        { id: 'discussion', name: 'Discussion', icon: 'fa-comments', canRemove: true, canHide: true, canMove: true },
                        { id: 'conclusion', name: 'Conclusion', icon: 'fa-flag-checkered', canRemove: true, canHide: true, canMove: true },
                        { id: 'references-section', name: 'References', icon: 'fa-book', canRemove: false, canHide: false, canMove: false },
                        { id: 'appendix', name: 'Appendix', icon: 'fa-paperclip', canRemove: true, canHide: true, canMove: true },
                    ],
                    'assignment': [
                        { id: 'cover-page', name: 'Cover Page', icon: 'fa-address-card', canRemove: false, canHide: false, canMove: false },
                        { id: 'introduction', name: 'Introduction', icon: 'fa-lightbulb', canRemove: true, canHide: true, canMove: true },
                        { id: 'body', name: 'Main Body', icon: 'fa-file-alt', canRemove: true, canHide: true, canMove: true },
                        { id: 'conclusion', name: 'Conclusion', icon: 'fa-flag-checkered', canRemove: true, canHide: true, canMove: true },
                        { id: 'references-section', name: 'References', icon: 'fa-book', canRemove: false, canHide: false, canMove: false },
                    ],
                    'research-paper': [
                        { id: 'cover-page', name: 'Title Page', icon: 'fa-address-card', canRemove: false, canHide: false, canMove: false },
                        { id: 'abstract', name: 'Abstract', icon: 'fa-file-alt', canRemove: true, canHide: true, canMove: true },
                        { id: 'keywords', name: 'Keywords', icon: 'fa-tags', canRemove: true, canHide: true, canMove: true },
                        { id: 'introduction', name: 'Introduction', icon: 'fa-lightbulb', canRemove: true, canHide: true, canMove: true },
                        { id: 'literature-review', name: 'Literature Review', icon: 'fa-book-reader', canRemove: true, canHide: true, canMove: true },
                        { id: 'methodology', name: 'Methodology', icon: 'fa-cogs', canRemove: true, canHide: true, canMove: true },
                        { id: 'results', name: 'Results', icon: 'fa-chart-bar', canRemove: true, canHide: true, canMove: true },
                        { id: 'discussion', name: 'Discussion', icon: 'fa-comments', canRemove: true, canHide: true, canMove: true },
                        { id: 'conclusion', name: 'Conclusion', icon: 'fa-flag-checkered', canRemove: true, canHide: true, canMove: true },
                        { id: 'acknowledgements', name: 'Acknowledgements', icon: 'fa-hands-helping', canRemove: true, canHide: true, canMove: true },
                        { id: 'references-section', name: 'References', icon: 'fa-book', canRemove: false, canHide: false, canMove: false },
                        { id: 'appendix', name: 'Appendix', icon: 'fa-paperclip', canRemove: true, canHide: true, canMove: true },
                    ],
                    'thesis-chapter': [
                        { id: 'cover-page', name: 'Chapter Cover', icon: 'fa-address-card', canRemove: false, canHide: false, canMove: false },
                        { id: 'introduction', name: 'Introduction', icon: 'fa-lightbulb', canRemove: true, canHide: true, canMove: true },
                        { id: 'background', name: 'Background/Literature', icon: 'fa-book-reader', canRemove: true, canHide: true, canMove: true },
                        { id: 'methodology', name: 'Methodology/Approach', icon: 'fa-cogs', canRemove: true, canHide: true, canMove: true },
                        { id: 'results-findings', name: 'Results/Findings', icon: 'fa-chart-bar', canRemove: true, canHide: true, canMove: true },
                        { id: 'analysis-discussion', name: 'Analysis/Discussion', icon: 'fa-comments', canRemove: true, canHide: true, canMove: true },
                        { id: 'conclusion', name: 'Conclusion/Summary', icon: 'fa-flag-checkered', canRemove: true, canHide: true, canMove: true },
                        { id: 'references-section', name: 'References', icon: 'fa-book', canRemove: false, canHide: false, canMove: false },
                    ]
                };
                const defaultReportData = {
                    template: 'lab-report',
                    sectionsOrder: defaultSections['lab-report'].map(s => s.id),
                    sectionsConfig: defaultSections['lab-report'].reduce((acc, s) => {
                        acc[s.id] = { name: s.name, icon: s.icon, canRemove: s.canRemove, canHide: s.canHide, canMove: s.canMove };
                        return acc;
                    }, {}),
                    sectionsContent: {
                        'cover-page': {},
                        'abstract': '',
                        'introduction': '',
                        'methods': '',
                        'results': '',
                        'discussion': '',
                        'conclusion': '',
                        'references-section': [],
                        'appendix': '',
                    },
                    sectionsVisibility: defaultSections['lab-report'].reduce((acc, s) => {
                        acc[s.id] = true;
                        return acc;
                    }, {}),
                    versions: [],
                    editorMode: 'tinymce', 
                };
                const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const formatDate = (date) => date ? new Date(date).toLocaleDateString() : 'N/A';
                const formatDateTime = (timestamp) => new Date(timestamp).toLocaleString();
                const debounce = (func, delay) => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(func, delay);
                };
                const showLoading = (message = 'Processing...') => {
                    loadingMessage.textContent = message;
                    loadingOverlay.classList.add('show');
                };
                const hideLoading = () => {
                    loadingOverlay.classList.remove('show');
                };
                const showNotification = (message, type = 'info', duration = 4000) => {
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    let iconClass = 'fa-info-circle';
                    if (type === 'success') iconClass = 'fa-check-circle';
                    if (type === 'error') iconClass = 'fa-times-circle';
                    if (type === 'warning') iconClass = 'fa-exclamation-triangle';
                    notification.innerHTML = `
                        <i class="fas ${iconClass}"></i>
                        <span>${message}</span>
                    `;
                    notificationArea.appendChild(notification);
                    setTimeout(() => notification.classList.add('show'), 10);
                    const timerId = setTimeout(() => {
                        notification.classList.add('dismissing');
                        notification.addEventListener('transitionend', () => notification.remove());
                    }, duration);
                    notification.addEventListener('click', () => {
                        clearTimeout(timerId);
                        notification.classList.add('dismissing');
                        notification.addEventListener('transitionend', () => notification.remove());
                    });
                };
                const showModal = (modalElement) => modalElement.classList.add('show');
                const hideModal = (modalElement) => modalElement.classList.remove('show');
                const saveData = (showStatus = true) => {
                    try {
                        if (!Array.isArray(reportData.sectionsContent['references-section'])) {
                             reportData.sectionsContent['references-section'] = [];
                             console.warn("Corrected references-section to be an array.");
                        }
                        if (!Array.isArray(reportData.versions)) {
                             reportData.versions = [];
                             console.warn("Corrected versions to be an array.");
                        }
                        localStorage.setItem('elysianReportData', JSON.stringify(reportData));
                        localStorage.setItem('elysianTheme', currentTheme);
                        localStorage.setItem('elysianFocusMode', isFocusMode);
                        if (showStatus) updateSaveStatus('saved');
                    } catch (error) {
                        console.error('Error saving data to localStorage:', error);
                        showNotification('Error saving data. Storage might be full.', 'error');
                        if (showStatus) updateSaveStatus('error');
                    }
                };
                const loadData = () => {
                    try {
                        const savedData = localStorage.getItem('elysianReportData');
                        const savedTheme = localStorage.getItem('elysianTheme');
                        const savedFocusMode = localStorage.getItem('elysianFocusMode');
                        if (savedData) {
                            reportData = JSON.parse(savedData);
                            if (!reportData.sectionsConfig) reportData.sectionsConfig = {};
                            if (!reportData.sectionsVisibility) reportData.sectionsVisibility = {};
                            if (!reportData.versions) reportData.versions = [];
                            if (!reportData.editorMode) reportData.editorMode = 'tinymce'; 
                            ['cover-page', 'references-section'].forEach(coreId => {
                                if (!reportData.sectionsConfig[coreId]) {
                                     const defaultConfig = defaultSections[reportData.template]?.find(s => s.id === coreId) || defaultSections['lab-report'].find(s => s.id === coreId);
                                     if (defaultConfig) {
                                        reportData.sectionsConfig[coreId] = { name: defaultConfig.name, icon: defaultConfig.icon, canRemove: false, canHide: false, canMove: false };
                                     }
                                }
                                if (reportData.sectionsVisibility[coreId] === undefined) {
                                    reportData.sectionsVisibility[coreId] = true;
                                }
                            });
                            reportData.sectionsOrder.forEach(id => {
                                if (reportData.sectionsContent[id] === undefined) {
                                    reportData.sectionsContent[id] = (id === 'cover-page' ? {} : (id === 'references-section' ? [] : ''));
                                }
                            });
                        } else {
                            reportData = JSON.parse(JSON.stringify(defaultReportData));
                        }
                        currentTheme = savedTheme || 'light';
                        isFocusMode = savedFocusMode === 'true';
                        editorMode = reportData.editorMode || 'tinymce'; 
                    } catch (error) {
                        console.error('Error loading data from localStorage:', error);
                        showNotification('Error loading saved data. Using defaults.', 'error');
                        reportData = JSON.parse(JSON.stringify(defaultReportData));
                        currentTheme = 'light';
                        isFocusMode = false;
                        editorMode = 'tinymce';
                    }
                };
                const clearData = () => {
                    if (confirm('Are you sure you want to clear ALL saved data? This cannot be undone.')) {
                        localStorage.removeItem('elysianReportData');
                        localStorage.removeItem('elysianTheme');
                        localStorage.removeItem('elysianFocusMode');
                        showNotification('All saved data cleared.', 'success');
                        window.location.reload();
                    }
                };
                const applyTheme = () => {
                    document.body.classList.toggle('theme-dark', currentTheme === 'dark');
                    themeToggleBtn.innerHTML = `<i class="fas ${currentTheme === 'dark' ? 'fa-moon' : 'fa-sun'}"></i>`;
                };
                const toggleTheme = () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    applyTheme();
                    saveData(false);
                };
                const applyFocusMode = () => {
                    appLayout.classList.toggle('focus-mode', isFocusMode);
                    focusToggleBtn.innerHTML = `<i class="fas ${isFocusMode ? 'fa-compress-alt' : 'fa-expand-alt'}"></i>`;
                };
                const toggleFocusMode = () => {
                    isFocusMode = !isFocusMode;
                    applyFocusMode();
                    saveData(false);
                };
                const applyTemplate = (templateId) => {
                    if (!defaultSections[templateId]) {
                        console.error(`Template ${templateId} not found.`);
                        showNotification(`Template ${templateId} not found.`, 'error');
                        return;
                    }
                    reportData.template = templateId;
                    const templateSections = defaultSections[templateId];
                    reportData.sectionsOrder = templateSections.map(s => s.id);
                    reportData.sectionsConfig = templateSections.reduce((acc, s) => {
                        acc[s.id] = { name: s.name, icon: s.icon, canRemove: s.canRemove, canHide: s.canHide, canMove: s.canMove };
                        return acc;
                    }, {});
                    reportData.sectionsVisibility = templateSections.reduce((acc, s) => {
                        acc[s.id] = true;
                        return acc;
                    }, {});
                    const newContent = {
                        'cover-page': reportData.sectionsContent['cover-page'] || {},
                        'references-section': reportData.sectionsContent['references-section'] || []
                    };
                    reportData.sectionsOrder.forEach(id => {
                        if (id !== 'cover-page' && id !== 'references-section') {
                            newContent[id] = reportData.sectionsContent[id] !== undefined ? reportData.sectionsContent[id] : '';
                        }
                    });
                    reportData.sectionsContent = newContent;
                    document.querySelectorAll('.template-card.active').forEach(card => card.classList.remove('active'));
                    document.querySelector(`.template-card[data-template="${templateId}"]`)?.classList.add('active');
                    renderSections();
                    setActiveSection('cover-page');
                    saveData();
                    showNotification(`Switched to ${templateId} template.`, 'success');
                };
                const renderSections = () => {
                    sectionsList.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    reportData.sectionsOrder.forEach((sectionId, index) => {
                        const config = reportData.sectionsConfig[sectionId];
                        if (!config) {
                            console.warn(`Config not found for section ID: ${sectionId}. Skipping render.`);
                            return;
                        }
                        const isVisible = reportData.sectionsVisibility[sectionId] !== false;
                        const isCore = !config.canMove && !config.canRemove;
                        const sectionItem = document.createElement('div');
                        sectionItem.classList.add('section-item');
                        sectionItem.dataset.section = sectionId;
                        if (sectionId === activeSectionId) sectionItem.classList.add('active');
                        if (!isVisible) sectionItem.classList.add('hidden-section');
                        sectionItem.setAttribute('draggable', config.canMove ? 'true' : 'false');
                        const visibilityIconClass = isVisible ? 'fa-eye' : 'fa-eye-slash';
                        const visibilityTitle = isVisible ? 'Hide Section' : 'Show Section';
                        sectionItem.innerHTML = `
                            <div class="section-item-name">
                                ${config.canHide ? `<i class="fas ${visibilityIconClass} visibility-toggle" title="${visibilityTitle}"></i>` : '<i class="fas fa-eye placeholder-icon"></i>'}
                                <i class="fas ${config.icon || 'fa-file-alt'} section-icon"></i>
                                <span class="section-text">${config.name}</span>
                                ${isCore ? '<span class="tag">Core</span>' : ''}
                            </div>
                            <div class="section-actions">
                                ${config.canMove ? '<i class="fas fa-grip-vertical action-btn drag-handle" title="Drag to reorder"></i>' : ''}
                                ${config.canRemove ? '<i class="fas fa-trash-alt action-btn remove-section" title="Remove Section"></i>' : ''}
                            </div>
                        `;
                        sectionItem.addEventListener('click', (e) => {
                            if (!e.target.classList.contains('action-btn') && !e.target.classList.contains('visibility-toggle')) {
                                setActiveSection(sectionId);
                            }
                        });
                        if (config.canHide) {
                            sectionItem.querySelector('.visibility-toggle')?.addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleSectionVisibility(sectionId);
                            });
                        }
                        if (config.canRemove) {
                            sectionItem.querySelector('.remove-section')?.addEventListener('click', (e) => {
                                e.stopPropagation();
                                removeSection(sectionId);
                            });
                        }
                        if (config.canMove) {
                            sectionItem.addEventListener('dragstart', handleDragStart);
                            sectionItem.addEventListener('dragover', handleDragOver);
                            sectionItem.addEventListener('dragleave', handleDragLeave);
                            sectionItem.addEventListener('drop', handleDrop);
                            sectionItem.addEventListener('dragend', handleDragEnd);
                        }
                        fragment.appendChild(sectionItem);
                    });
                    sectionsList.appendChild(fragment);
                };
                const setActiveSection = (sectionId) => {
                    if (!sectionId || !reportData.sectionsConfig[sectionId]) {
                        console.warn(`Attempted to set invalid section ID: ${sectionId}. Falling back to cover page.`);
                        sectionId = 'cover-page';
                    }
                    if (activeSectionId && activeSectionId !== sectionId) {
                        saveCurrentSectionContent(false);
                    }
                    activeSectionId = sectionId;
                    document.querySelectorAll('.section-item.active').forEach(item => item.classList.remove('active'));
                    document.querySelector(`.section-item[data-section="${sectionId}"]`)?.classList.add('active');
                    const config = reportData.sectionsConfig[sectionId];
                    currentSectionTitle.textContent = config?.name || 'Unknown Section';
                    currentSectionIcon.className = `fas ${config?.icon || 'fa-file-alt'}`;
                    if (sectionId === 'cover-page') {
                        switchTab('form');
                        loadCoverPageData();
                    } else if (sectionId === 'references-section') {
                        switchTab('references');
                        renderReferences();
                    } else {
                        switchTab('editor');
                        loadSectionContent(); 
                    }
                    updateEditorModeView(); 
                };
                const addSection = () => {
                    const name = newSectionNameInput.value.trim();
                    if (!name) {
                        showNotification('Please enter a section name.', 'warning');
                        return;
                    }
                    const newSectionId = generateId();
                    const newSectionConfig = { name: name, icon: 'fa-file-alt', canRemove: true, canHide: true, canMove: true };
                    reportData.sectionsConfig[newSectionId] = newSectionConfig;
                    reportData.sectionsContent[newSectionId] = '';
                    reportData.sectionsVisibility[newSectionId] = true;
                    const refIndex = reportData.sectionsOrder.indexOf('references-section');
                    if (refIndex > -1) {
                        reportData.sectionsOrder.splice(refIndex, 0, newSectionId);
                    } else {
                        reportData.sectionsOrder.push(newSectionId);
                    }
                    renderSections();
                    setActiveSection(newSectionId);
                    hideModal(addSectionModal);
                    newSectionNameInput.value = '';
                    saveData();
                    showNotification(`Section "${name}" added.`, 'success');
                };
                const removeSection = (sectionId) => {
                    const config = reportData.sectionsConfig[sectionId];
                    if (!config || !config.canRemove) return;
                    if (confirm(`Are you sure you want to remove the section "${config.name}"? This cannot be undone.`)) {
                        reportData.sectionsOrder = reportData.sectionsOrder.filter(id => id !== sectionId);
                        delete reportData.sectionsContent[sectionId];
                        delete reportData.sectionsConfig[sectionId];
                        delete reportData.sectionsVisibility[sectionId];
                        if (activeSectionId === sectionId) {
                            const currentIndex = reportData.sectionsOrder.indexOf(sectionId);
                            const newActiveIndex = Math.max(0, currentIndex -1);
                             setActiveSection(reportData.sectionsOrder[newActiveIndex] || 'cover-page');
                        }
                        renderSections();
                        saveData();
                        showNotification(`Section "${config.name}" removed.`, 'success');
                    }
                };
                const toggleSectionVisibility = (sectionId) => {
                    const config = reportData.sectionsConfig[sectionId];
                     if (!config || !config.canHide) return;
                    reportData.sectionsVisibility[sectionId] = !reportData.sectionsVisibility[sectionId];
                    const sectionItem = document.querySelector(`.section-item[data-section="${sectionId}"]`);
                    if (sectionItem) {
                        const isVisible = reportData.sectionsVisibility[sectionId];
                        sectionItem.classList.toggle('hidden-section', !isVisible);
                        const icon = sectionItem.querySelector('.visibility-toggle');
                        if (icon) {
                            icon.className = `fas ${isVisible ? 'fa-eye' : 'fa-eye-slash'} visibility-toggle`;
                            icon.title = isVisible ? 'Hide Section' : 'Show Section';
                        }
                    }
                    saveData();
                    showNotification(`Section "${config.name}" ${reportData.sectionsVisibility[sectionId] ? 'shown' : 'hidden'}.`, 'info');
                };
                function handleDragStart(e) {
                    if (e.target.classList.contains('section-item') && e.target.draggable) {
                        dragSrcElement = e.target;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', e.target.dataset.section);
                        e.target.classList.add('dragging');
                    } else {
                        e.preventDefault();
                    }
                }
                function handleDragOver(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const targetElement = e.target.closest('.section-item');
                    if (targetElement && targetElement !== dragSrcElement && targetElement.draggable) {
                         targetElement.style.borderTop = '2px dashed var(--primary-color)';
                    }
                }
                function handleDragLeave(e) {
                   const targetElement = e.target.closest('.section-item');
                    if (targetElement) {
                        targetElement.style.borderTop = '';
                    }
                }
                function handleDrop(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const targetElement = e.target.closest('.section-item');
                     if (targetElement) {
                        targetElement.style.borderTop = '';
                    }
                    if (dragSrcElement && targetElement && dragSrcElement !== targetElement && targetElement.draggable) {
                        const sourceId = dragSrcElement.dataset.section;
                        const targetId = targetElement.dataset.section;
                        const sourceIndex = reportData.sectionsOrder.indexOf(sourceId);
                        let targetIndex = reportData.sectionsOrder.indexOf(targetId);
                        if (sourceIndex > -1 && targetIndex > -1) {
                            reportData.sectionsOrder.splice(sourceIndex, 1);
                             targetIndex = reportData.sectionsOrder.indexOf(targetId);
                            reportData.sectionsOrder.splice(targetIndex, 0, sourceId);
                            renderSections();
                            saveData();
                            showNotification('Section order updated.', 'info');
                        } else {
                             console.error("Drag/Drop Error: Section ID not found in order array.");
                        }
                    }
                }
                function handleDragEnd(e) {
                    this.classList.remove('dragging');
                    document.querySelectorAll('.section-item').forEach(item => {
                        item.style.borderTop = '';
                    });
                    dragSrcElement = null;
                }
                const switchTab = (tabId) => {
                    tabContents.forEach(content => content.classList.remove('active'));
                    tabButtons.forEach(button => button.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`)?.classList.add('active');
                    document.querySelector(`.tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
                    const editorTabContent = document.getElementById('editor-tab');
                    const editorTabButton = document.querySelector('.tab-btn[data-tab="editor"]');
                    if (activeSectionId === 'cover-page' || activeSectionId === 'references-section') {
                        editorTabContent?.classList.add('hidden');
                        editorTabButton?.classList.add('hidden');
                    } else {
                        editorTabContent?.classList.remove('hidden');
                        editorTabButton?.classList.remove('hidden');
                    }
                    const formTabContent = document.getElementById('form-tab');
                    const formTabButton = document.querySelector('.tab-btn[data-tab="form"]');
                     if (activeSectionId !== 'cover-page') {
                        formTabContent?.classList.add('hidden');
                        formTabButton?.classList.add('hidden');
                    } else {
                        formTabContent?.classList.remove('hidden');
                        formTabButton?.classList.remove('hidden');
                    }
                    const referencesTabContent = document.getElementById('references-tab');
                    const referencesTabButton = document.querySelector('.tab-btn[data-tab="references"]');
                     if (activeSectionId !== 'references-section') {
                        referencesTabContent?.classList.add('hidden');
                        referencesTabButton?.classList.add('hidden');
                    } else {
                        referencesTabContent?.classList.remove('hidden');
                        referencesTabButton?.classList.remove('hidden');
                    }
                    if (document.querySelector('.tab-btn.active.hidden')) {
                         if (activeSectionId === 'cover-page') {
                             document.querySelector('.tab-btn[data-tab="form"]')?.classList.add('active');
                             document.getElementById('form-tab')?.classList.add('active');
                         } else if (activeSectionId === 'references-section') {
                             document.querySelector('.tab-btn[data-tab="references"]')?.classList.add('active');
                             document.getElementById('references-tab')?.classList.add('active');
                         } else {
                             document.querySelector('.tab-btn[data-tab="editor"]')?.classList.add('active');
                             document.getElementById('editor-tab')?.classList.add('active');
                         }
                    }
                };
                const loadCoverPageData = () => {
                    const coverData = reportData.sectionsContent['cover-page'] || {};
                    coverPageForm.querySelectorAll('input[type="text"], input[type="url"], input[type="date"], input[type="email"], input[type="tel"]').forEach(input => {
                        const key = input.id.replace('cover-', '').replace(/-/g, '_');
                        input.value = coverData[key] || '';
                    });
                };
                const saveCoverPageData = () => {
                    const coverData = reportData.sectionsContent['cover-page'] || {};
                    coverPageForm.querySelectorAll('input[type="text"], input[type="url"], input[type="date"], input[type="email"], input[type="tel"]').forEach(input => {
                        const key = input.id.replace('cover-', '').replace(/-/g, '_');
                        coverData[key] = input.value.trim();
                    });
                    reportData.sectionsContent['cover-page'] = coverData;
                    debounce(saveData, 1000);
                    updateSaveStatus('unsaved');
                };
                const initializeTinyMCE = (initialContent = '') => {
                    if (typeof tinymce === 'undefined') {
                        console.error("TinyMCE library not loaded!");
                        showNotification("Editor library (TinyMCE) not found.", "error");
                        if (tinymceEditorArea) tinymceEditorArea.innerHTML = '<p style="color: red;">Error: TinyMCE library not found.</p>';
                        return;
                    }
                    if (tinymce.get('editor-tinymce')) {
                        tinymce.get('editor-tinymce').remove();
                    }
                    tinymce.init({
                        selector: '#editor-tinymce',
                        plugins: 'preview powerpaste casechange importcss searchreplace autolink autosave save directionality advcode visualblocks visualchars fullscreen image link media mediaembed codesample table charmap pagebreak nonbreaking anchor tableofcontents insertdatetime advlist lists checklist wordcount tinymcespellchecker help formatpainter permanentpen pageembed linkchecker emoticons advtable export',
                        toolbar: 'undo redo | blocks | bold italic strikethrough | bullist numlist | blockquote | link image table | code | removeformat | wordcount',
                        height: 450,
                        menubar: 'file edit view insert format tools table help',
                        placeholder: 'Start writing your section content here...',
                        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }', 
                        init_instance_callback: function (editor) {
                            if (initialContent) {
                                editor.setContent(initialContent);
                            }
                            updateWordCount(); 
                            updateSaveStatus('saved'); 
                        },
                        setup: function (editor) {
                            editor.on('change input undo redo SetContent', function () {
                                updateWordCount();
                                updateSaveStatus('unsaved');
                                debounce(saveCurrentSectionContent, 1500); 
                            });
                        },
                    }).catch(error => {
                        console.error("Error initializing TinyMCE:", error);
                        showNotification("Failed to initialize the editor.", "error");
                    });
                };
                const loadSectionContent = () => {
                    if (!activeSectionId || activeSectionId === 'cover-page' || activeSectionId === 'references-section') {
                        if (editorMode === 'tinymce' && typeof tinymce !== 'undefined' && tinymce.get('editor-tinymce')) {
                            tinymce.get('editor-tinymce').setContent('');
                        }
                        markdownEditor.value = '';
                        updateMarkdownPreview();
                        updateWordCount();
                        return;
                    }
                    const content = reportData.sectionsContent[activeSectionId] || '';
                    let contentForEditor = '';
                    if (editorMode === 'tinymce') {
                        if (isLikelyMarkdown(content) && window.marked) {
                            try {
                                contentForEditor = marked.parse(content); 
                            } catch (e) {
                                console.error("Error parsing Markdown for TinyMCE:", e);
                                contentForEditor = content; 
                            }
                        } else {
                            contentForEditor = content; 
                        }
                    } else { 
                        if (!isLikelyMarkdown(content) && window.TurndownService) {
                             if (!turndownService) turndownService = new TurndownService({ headingStyle: 'atx', bulletListMarker: '*' });
                             try {
                                 contentForEditor = turndownService.turndown(content); 
                             } catch(e) {
                                 console.error("Error converting HTML to Markdown:", e);
                                 contentForEditor = content; 
                             }
                        } else {
                             contentForEditor = content; 
                        }
                    }
                    if (editorMode === 'tinymce') {
                        if (document.getElementById('editor-tinymce')) {
                            const editor = tinymce.get('editor-tinymce');
                            if (editor) {
                                editor.setContent(contentForEditor || ''); 
                                editor.undoManager.clear(); 
                                editor.nodeChanged(); 
                            } else {
                                initializeTinyMCE(contentForEditor); 
                            }
                        }
                        markdownEditor.value = ''; 
                        updateMarkdownPreview();
                    } else { 
                        if (typeof tinymce !== 'undefined' && tinymce.get('editor-tinymce')) {
                            tinymce.get('editor-tinymce').remove();
                        }
                        markdownEditor.value = contentForEditor; 
                        updateMarkdownPreview();
                    }
                    updateWordCount();
                    updateSaveStatus('saved'); 
                };
                const saveCurrentSectionContent = (showStatus = true) => {
                    if (!activeSectionId || !reportData.sectionsContent || activeSectionId === 'cover-page' || activeSectionId === 'references-section') {
                        if (activeSectionId === 'cover-page') saveCoverPageData();
                        return;
                    }
                    let contentToSave = '';
                    const editor = (typeof tinymce !== 'undefined') ? tinymce.get('editor-tinymce') : null;
                    if (editorMode === 'tinymce' && editor) {
                        contentToSave = editor.getContent();
                    } else if (editorMode === 'markdown') {
                        contentToSave = markdownEditor.value;
                    }
                    if (reportData.sectionsContent[activeSectionId] !== contentToSave) {
                        reportData.sectionsContent[activeSectionId] = contentToSave;
                        debounce(() => saveData(showStatus), 500);
                        if (showStatus) updateSaveStatus('saving');
                    } else {
                        if (showStatus) updateSaveStatus('saved');
                    }
                };
                const updateWordCount = () => {
                    let count = 0;
                    const editor = (typeof tinymce !== 'undefined') ? tinymce.get('editor-tinymce') : null;
                    if (editorMode === 'tinymce' && editor && editor.plugins && editor.plugins.wordcount) {
                        count = editor.plugins.wordcount.getCount();
                    } else if (editorMode === 'markdown') {
                        const text = markdownEditor.value.trim();
                        count = text ? text.split(/\s+/).length : 0;
                    }
                    wordCountEl.textContent = `Words: ${count}`;
                };
                const updateSaveStatus = (status) => { 
                    saveStatusEl.classList.remove('visible', 'unsaved', 'saving', 'saved', 'error');
                    if (status !== 'hidden') {
                        saveStatusEl.classList.add('visible', status);
                        let iconClass = 'fa-check-circle';
                        let text = 'Saved';
                        switch (status) {
                            case 'unsaved': iconClass = 'fa-edit'; text = 'Unsaved'; break;
                            case 'saving': iconClass = 'fa-spinner fa-spin'; text = 'Saving...'; break;
                            case 'error': iconClass = 'fa-exclamation-circle'; text = 'Error'; break;
                            case 'saved': iconClass = 'fa-check-circle'; text = 'Saved'; break;
                        }
                        saveStatusEl.innerHTML = `<i class="fas ${iconClass}"></i> <span>${text}</span>`;
                    }
                };
                const toggleEditorMode = () => {
                    saveCurrentSectionContent(false); 
                    const newMode = (editorMode === 'tinymce') ? 'markdown' : 'tinymce';
                    editorMode = newMode;
                    reportData.editorMode = editorMode;
                    saveData(false);
                    updateEditorModeView(); 
                    loadSectionContent(); 
                    toggleEditorModeBtn.querySelector('.mode-indicator').textContent = `(${(editorMode === 'tinymce' ? 'Rich Text' : 'Markdown')})`;
                    showNotification(`Switched to ${editorMode === 'tinymce' ? 'Rich Text' : 'Markdown'} editor mode.`, 'info');
                };
                const updateEditorModeView = () => {
                     if (editorMode === 'tinymce') {
                        if (tinymceEditorArea) tinymceEditorArea.classList.remove('hidden');
                        markdownEditorArea.classList.add('hidden');
                    } else { 
                        if (tinymceEditorArea) tinymceEditorArea.classList.add('hidden');
                        markdownEditorArea.classList.remove('hidden');
                        if (typeof tinymce !== 'undefined' && tinymce.get('editor-tinymce')) {
                            tinymce.get('editor-tinymce').remove();
                        }
                    }
                };
                const updateMarkdownPreview = () => {
                    if (window.marked && markdownPreview) {
                        try {
                            markdownPreview.innerHTML = marked.parse(markdownEditor.value || '');
                            if (window.Prism) {
                                Prism.highlightAllUnder(markdownPreview);
                            }
                        } catch (e) {
                            markdownPreview.innerHTML = `<p style="color: red;">Error rendering Markdown preview.</p>`;
                            console.error("Markdown Preview Error:", e);
                        }
                    }
                };
                const isLikelyMarkdown = (text) => {
                    if (!text || typeof text !== 'string') return false;
                    return /^(#+\s|\*\s|-\s|\d+\.\s|`{3}|>|\[.*\]\(.*\))/.test(text.trim()) ||
                           /\n\n/.test(text) ||
                           /(\*\*|__|\*|_|`|~~)/.test(text);
                };
                const updateRefFormFields = () => {
                    const selectedType = refTypeSelect.value;
                    refFields.forEach(field => {
                        const hasTypeClass = Array.from(field.classList).some(cls => ['journal', 'book', 'website', 'other'].includes(cls));
                        if (!hasTypeClass || field.classList.contains(selectedType)) {
                            field.style.display = 'block';
                        } else {
                            field.style.display = 'none';
                        }
                    });
                     document.querySelectorAll('#reference-form .form-group').forEach(group => {
                         const input = group.querySelector('input, select, textarea');
                         if (!input) return;
                         const id = input.id;
                         let show = false;
                         switch (selectedType) {
                             case 'journal':
                                 show = ['ref-key', 'ref-authors', 'ref-year', 'ref-title', 'ref-source', 'ref-volume', 'ref-pages'].includes(id);
                                 if (id === 'ref-source') group.querySelector('label').textContent = 'Journal Name';
                                 if (id === 'ref-pages') group.querySelector('label').textContent = 'Pages / DOI';
                                 break;
                             case 'book':
                                 show = ['ref-key', 'ref-authors', 'ref-year', 'ref-title', 'ref-source', 'ref-pages'].includes(id);
                                  if (id === 'ref-source') group.querySelector('label').textContent = 'Publisher / City';
                                  if (id === 'ref-pages') group.querySelector('label').textContent = 'Pages / Edition';
                                 break;
                             case 'website':
                                 show = ['ref-key', 'ref-authors', 'ref-year', 'ref-title', 'ref-url', 'ref-access-date'].includes(id);
                                 break;
                             case 'other':
                                 show = ['ref-key', 'ref-authors', 'ref-year', 'ref-title', 'ref-details'].includes(id);
                                 break;
                         }
                         group.style.display = show ? 'block' : 'none';
                     });
                     document.getElementById('ref-type').closest('.form-group').style.display = 'block';
                };
                const clearRefForm = () => {
                    refForm.querySelectorAll('input[type="text"], input[type="number"], input[type="url"], input[type="date"], textarea').forEach(input => input.value = '');
                    refTypeSelect.value = 'journal';
                    updateRefFormFields();
                    currentEditingRefId = null;
                    addReferenceBtn.classList.remove('hidden');
                    updateReferenceBtn.classList.add('hidden');
                    cancelEditReferenceBtn.classList.add('hidden');
                    refForm.querySelector('h4').textContent = 'Add New Reference';
                };
                const addReference = () => {
                    const newRef = {
                        id: generateId(), type: refTypeSelect.value, key: document.getElementById('ref-key').value.trim(),
                        authors: document.getElementById('ref-authors').value.trim(), year: document.getElementById('ref-year').value.trim(),
                        title: document.getElementById('ref-title').value.trim(),
                    };
                    if (!newRef.key || !newRef.authors || !newRef.year || !newRef.title) {
                        showNotification('Please fill in required reference fields (Key, Authors, Year, Title).', 'warning'); return;
                    }
                    switch (newRef.type) {
                        case 'journal':
                            newRef.source = document.getElementById('ref-source').value.trim(); newRef.volume = document.getElementById('ref-volume').value.trim();
                            newRef.pages = document.getElementById('ref-pages').value.trim(); break;
                        case 'book':
                            newRef.source = document.getElementById('ref-source').value.trim(); newRef.pages = document.getElementById('ref-pages').value.trim(); break;
                        case 'website':
                            newRef.url = document.getElementById('ref-url').value.trim(); newRef.accessDate = document.getElementById('ref-access-date').value; break;
                        case 'other':
                            newRef.details = document.getElementById('ref-details').value.trim(); break;
                    }
                    if (!Array.isArray(reportData.sectionsContent['references-section'])) reportData.sectionsContent['references-section'] = [];
                    reportData.sectionsContent['references-section'].push(newRef);
                    renderReferences(); clearRefForm(); saveData(); showNotification('Reference added successfully.', 'success');
                };
                const editReference = (refId) => {
                    const ref = reportData.sectionsContent['references-section'].find(r => r.id === refId); if (!ref) return;
                    currentEditingRefId = refId;
                    refTypeSelect.value = ref.type; document.getElementById('ref-key').value = ref.key || '';
                    document.getElementById('ref-authors').value = ref.authors || ''; document.getElementById('ref-year').value = ref.year || '';
                    document.getElementById('ref-title').value = ref.title || ''; document.getElementById('ref-source').value = ref.source || '';
                    document.getElementById('ref-volume').value = ref.volume || ''; document.getElementById('ref-pages').value = ref.pages || '';
                    document.getElementById('ref-url').value = ref.url || ''; document.getElementById('ref-access-date').value = ref.accessDate || '';
                    document.getElementById('ref-details').value = ref.details || '';
                    updateRefFormFields();
                    addReferenceBtn.classList.add('hidden'); updateReferenceBtn.classList.remove('hidden'); cancelEditReferenceBtn.classList.remove('hidden');
                    refForm.querySelector('h4').textContent = 'Edit Reference'; refForm.scrollIntoView({ behavior: 'smooth' });
                };
                const updateReference = () => {
                    if (!currentEditingRefId) return;
                    const refIndex = reportData.sectionsContent['references-section'].findIndex(r => r.id === currentEditingRefId); if (refIndex === -1) return;
                    const updatedRef = {
                        id: currentEditingRefId, type: refTypeSelect.value, key: document.getElementById('ref-key').value.trim(),
                        authors: document.getElementById('ref-authors').value.trim(), year: document.getElementById('ref-year').value.trim(),
                        title: document.getElementById('ref-title').value.trim(),
                    };
                    if (!updatedRef.key || !updatedRef.authors || !updatedRef.year || !updatedRef.title) {
                        showNotification('Please fill in required reference fields (Key, Authors, Year, Title).', 'warning'); return;
                    }
                    switch (updatedRef.type) {
                        case 'journal': updatedRef.source = document.getElementById('ref-source').value.trim(); updatedRef.volume = document.getElementById('ref-volume').value.trim(); updatedRef.pages = document.getElementById('ref-pages').value.trim(); break;
                        case 'book': updatedRef.source = document.getElementById('ref-source').value.trim(); updatedRef.pages = document.getElementById('ref-pages').value.trim(); break;
                        case 'website': updatedRef.url = document.getElementById('ref-url').value.trim(); updatedRef.accessDate = document.getElementById('ref-access-date').value; break;
                        case 'other': updatedRef.details = document.getElementById('ref-details').value.trim(); break;
                    }
                    reportData.sectionsContent['references-section'][refIndex] = updatedRef;
                    renderReferences(); clearRefForm(); saveData(); showNotification('Reference updated successfully.', 'success');
                };
                const deleteReference = (refId) => {
                    if (confirm('Are you sure you want to delete this reference?')) {
                        reportData.sectionsContent['references-section'] = reportData.sectionsContent['references-section'].filter(r => r.id !== refId);
                        renderReferences(); if (currentEditingRefId === refId) clearRefForm();
                        saveData(); showNotification('Reference deleted.', 'success');
                    }
                };
                const renderReferences = () => {
                    const references = reportData.sectionsContent['references-section'] || [];
                    referencesListContainer.innerHTML = '';
                    if (references.length === 0) { referencesListContainer.innerHTML = '<p>No references added yet.</p>'; return; }
                    references.sort((a, b) => (a.key || '').localeCompare(b.key || ''));
                    references.forEach(ref => {
                        const item = document.createElement('div'); item.className = 'reference-item'; item.dataset.refId = ref.id;
                        let detailsHtml = `<strong>[${ref.key || 'No Key'}]</strong> ${ref.authors || 'N/A'} (${ref.year || 'N/A'}). <em>${ref.title || 'N/A'}</em>.`;
                        switch (ref.type) {
                            case 'journal': detailsHtml += ` ${ref.source || ''}. ${ref.volume || ''}: ${ref.pages || ''}.`; break;
                            case 'book': detailsHtml += ` ${ref.source || ''}. ${ref.pages ? `pp. ${ref.pages}` : ''}.`; break;
                            case 'website': detailsHtml += ` Retrieved from <a href="${ref.url || '#'}" target="_blank">${ref.url || 'N/A'}</a>${ref.accessDate ? ` (Accessed: ${formatDate(ref.accessDate)})` : ''}.`; break;
                            case 'other': detailsHtml += ` ${ref.details || ''}.`; break;
                        }
                        item.innerHTML = `<div class="reference-details">${detailsHtml}</div> <div class="reference-actions"> <button class="btn btn-secondary btn-sm edit-ref-btn"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger btn-sm delete-ref-btn"><i class="fas fa-trash"></i> Delete</button> </div>`;
                        item.querySelector('.edit-ref-btn').addEventListener('click', () => editReference(ref.id));
                        item.querySelector('.delete-ref-btn').addEventListener('click', () => deleteReference(ref.id));
                        referencesListContainer.appendChild(item);
                    });
                };
                const MAX_VERSIONS = 10;
                const saveVersion = () => {
                    const currentDataSnapshot = JSON.stringify(reportData); const timestamp = Date.now();
                    const lastVersion = reportData.versions[reportData.versions.length - 1];
                    if (lastVersion && lastVersion.data === currentDataSnapshot) { showNotification('No changes detected since last saved version.', 'info'); return; }
                    reportData.versions.push({ timestamp: timestamp, data: currentDataSnapshot });
                    if (reportData.versions.length > MAX_VERSIONS) reportData.versions.shift();
                    renderVersionHistory(); saveData(); showNotification(`Version saved at ${formatDateTime(timestamp)}.`, 'success');
                };
                const renderVersionHistory = () => {
                    versionHistoryList.innerHTML = ''; if (!reportData.versions || reportData.versions.length === 0) { versionHistoryList.innerHTML = '<p>No versions saved yet.</p>'; return; }
                    [...reportData.versions].reverse().forEach(version => {
                        const item = document.createElement('div'); item.className = 'version-item';
                        item.innerHTML = `<span>${formatDateTime(version.timestamp)}</span> <button class="btn btn-subtle btn-sm restore-version-btn" data-timestamp="${version.timestamp}"><i class="fas fa-undo"></i> Restore</button>`;
                        item.querySelector('.restore-version-btn').addEventListener('click', () => promptRestoreVersion(version.timestamp));
                        versionHistoryList.appendChild(item);
                    });
                };
                const promptRestoreVersion = (timestamp) => { versionToRestore = timestamp; restoreVersionTimestampEl.textContent = formatDateTime(timestamp); showModal(restoreVersionModal); };
                const restoreVersion = () => {
                    if (!versionToRestore) return;
                    const versionData = reportData.versions.find(v => v.timestamp === versionToRestore);
                    if (!versionData || !versionData.data) { showNotification('Error finding version data to restore.', 'error'); hideModal(restoreVersionModal); return; }
                    try {
                        const restoredReportData = JSON.parse(versionData.data); reportData = restoredReportData;
                        applyTheme(); applyFocusMode(); renderSections(); renderReferences(); renderVersionHistory();
                        editorMode = reportData.editorMode || 'tinymce'; 
                        updateEditorModeView(); 
                        toggleEditorModeBtn.querySelector('.mode-indicator').textContent = `(${(editorMode === 'tinymce' ? 'Rich Text' : 'Markdown')})`;
                        setActiveSection(reportData.sectionsOrder[0] || 'cover-page');
                        updateTemplateCardSelection();
                        saveData(); hideModal(restoreVersionModal); showNotification(`Report restored to version from ${formatDateTime(versionToRestore)}.`, 'success');
                        versionToRestore = null;
                    } catch (error) {
                        console.error('Error parsing or applying restored version:', error); showNotification('Error restoring version. Data might be corrupted.', 'error');
                        hideModal(restoreVersionModal); versionToRestore = null;
                    }
                };
                 const updateTemplateCardSelection = () => {
                    document.querySelectorAll('.template-card.active').forEach(card => card.classList.remove('active'));
                    const currentTemplateCard = document.querySelector(`.template-card[data-template="${reportData.template}"]`);
                    if (currentTemplateCard) currentTemplateCard.classList.add('active');
                };
                const generateReportHTMLForPreview = (forPDF = false) => {
                    let html = '';
                    const coverData = reportData.sectionsContent['cover-page'] || {};
                    const references = reportData.sectionsContent['references-section'] || [];
                    const visibleSections = reportData.sectionsOrder.filter(id => reportData.sectionsVisibility[id] !== false);
                    if (reportData.sectionsVisibility['cover-page'] !== false) {
                        html += `<div class="report-section cover-page" id="preview-cover-page"><div class="cover-page-content">`;
                        html += `<div class="cover-page-top">`;
                        if (coverData.logo_url) html += `<img src="${coverData.logo_url}" alt="${coverData.institution_name || 'Institution'} Logo" class="institution-logo">`;
                        if (coverData.institution_name) html += `<p class="institution-name" style="font-size: 14pt; margin-bottom: 2cm;">${coverData.institution_name}</p>`;
                        html += `</div>`; 
                        html += `<div class="cover-page-middle">`;
                        if (coverData.report_title) html += `<h1 class="report-title">${coverData.report_title}</h1>`;
                        if (coverData.report_subtitle) html += `<h2 class="report-subtitle">${coverData.report_subtitle}</h2>`;
                        html += `</div>`; 
                        html += `<div class="cover-page-bottom">`;
                        html += `<div class="author-info" style="margin-bottom: 1.5cm;">`;
                        if (coverData.author_name) html += `<p class="author-name">${coverData.author_name}</p>`;
                        if (coverData.student_id) html += `<p>Student ID: ${coverData.student_id}</p>`;
                        if (coverData.department) html += `<p>Department: ${coverData.department}</p>`;
                        if (coverData.semester) html += `<p>Semester: ${coverData.semester}</p>`;
                        html += `</div>`; 
                        html += `<div class="submission-info">`;
                        if (coverData.course_name || coverData.course_code) html += `<p><strong>${coverData.course_name || ''}</strong> ${coverData.course_code ? `(${coverData.course_code})` : ''}</p>`;
                        if (coverData.lab_section) html += `<p>Lab Section: ${coverData.lab_section}</p>`;
                        if (coverData.assignment_number) html += `<p>Assignment: ${coverData.assignment_number}</p>`;
                        if (coverData.instructor_name) {
                            html += `<p style="margin-top: 1cm;">Submitted to:</p><p><strong>${coverData.instructor_name}</strong></p>`;
                            if (coverData.instructor_designation) html += `<p>${coverData.instructor_designation}</p>`;
                            if (coverData.instructor_department) html += `<p>${coverData.instructor_department}</p>`;
                        }
                        if (coverData.experiment_date) html += `<p style="margin-top: 0.5cm;">Date of Experiment: ${formatDate(coverData.experiment_date)}</p>`;
                        if (coverData.submission_date) html += `<p>Date of Submission: ${formatDate(coverData.submission_date)}</p>`;
                        html += `</div></div></div></div>`; 
                    }
                    visibleSections.forEach(sectionId => {
                        if (sectionId === 'cover-page' || sectionId === 'references-section') return;
                        const config = reportData.sectionsConfig[sectionId];
                        let content = reportData.sectionsContent[sectionId] || '';
                        if (isLikelyMarkdown(content) && window.marked) {
                             try { content = marked.parse(content); } catch(e) { console.error(`MD parse error in preview for ${sectionId}:`, e); }
                        }
                        html += `<div class="report-section" id="preview-${sectionId}">`;
                        if (config?.name) html += `<h2 class="report-section-title">${config.name}</h2>`;
                        content = content.replace(/<table/g, '<table class="report-table"');
                        content = content.replace(/<img/g, '<img class="report-image"');
                        html += `<div class="section-content-wrapper">${content || '<p><i>Section is empty.</i></p>'}</div>`;
                        html += `</div>`;
                    });
                    if (reportData.sectionsVisibility['references-section'] !== false && references.length > 0) {
                        html += `<div class="report-section references-section" id="preview-references-section">`;
                        html += `<h2 class="report-section-title">References</h2>`;
                        html += `<ol class="references-list-preview">`;
                        references.sort((a, b) => (a.key || '').localeCompare(b.key || ''));
                        references.forEach(ref => {
                            let refHtml = `<li><strong>[${ref.key || 'No Key'}]</strong> ${ref.authors || 'N/A'} (${ref.year || 'N/A'}). <em>${ref.title || 'N/A'}</em>.`;
                             switch (ref.type) {
                                case 'journal': refHtml += ` ${ref.source || ''}. ${ref.volume || ''}: ${ref.pages || ''}.`; break;
                                case 'book': refHtml += ` ${ref.source || ''}. ${ref.pages ? `pp. ${ref.pages}` : ''}.`; break;
                                case 'website': refHtml += ` Retrieved from <a href="${ref.url || '#'}" target="_blank">${ref.url || 'N/A'}</a>${ref.accessDate ? ` (Accessed: ${formatDate(ref.accessDate)})` : ''}.`; break;
                                case 'other': refHtml += ` ${ref.details || ''}.`; break;
                            }
                            refHtml += `</li>`; html += refHtml;
                        });
                        html += `</ol></div>`;
                    }
                    return html;
                };
                const showPreview = () => {
                    try {
                        const previewHtml = generateReportHTMLForPreview(); previewContentArea.innerHTML = previewHtml;
                        showModal(previewModal);
                    } catch (error) { console.error("Error generating preview:", error); showNotification("Failed to generate preview.", "error"); }
                };
                const downloadPDF = async () => {
                    if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') { showNotification('PDF generation libraries not loaded.', 'error'); console.error('jsPDF or html2canvas not found.'); return; }
                    showLoading('Generating PDF...');
                    const previewHtml = generateReportHTMLForPreview(true); previewContentArea.innerHTML = previewHtml;
                    previewModal.style.display = 'block'; previewModal.style.opacity = '0'; previewModal.style.position = 'fixed'; previewModal.style.top = '-9999px';
                    await new Promise(resolve => setTimeout(resolve, 100));
                    try {
                        const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', putOnlyUsedFonts: true, floatPrecision: 16 });
                        const canvas = await html2canvas(previewContentArea, { scale: 2, useCORS: true, logging: false });
                        const imgData = canvas.toDataURL('image/png'); const imgProps = pdf.getImageProperties(imgData);
                        const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgWidth = pdfWidth - 36; const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                        let heightLeft = imgHeight; let position = 0; const pageMargin = 20;
                        pdf.addImage(imgData, 'PNG', 18, pageMargin, imgWidth, imgHeight); heightLeft -= (pdfHeight - 2 * pageMargin);
                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight; pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 18, position + pageMargin, imgWidth, imgHeight); heightLeft -= (pdfHeight - 2 * pageMargin);
                        }
                        const pageCount = pdf.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) { pdf.setPage(i); pdf.setFontSize(10); pdf.setTextColor(100); pdf.text(`Page ${i} of ${pageCount}`, pdfWidth / 2, pdfHeight - 10, { align: 'center' }); }
                        const filename = (reportData.sectionsContent?.coverPage?.report_title || 'academic-report').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.pdf';
                        pdf.save(filename); showNotification('PDF downloaded successfully.', 'success');
                    } catch (error) { console.error('Error generating PDF:', error); showNotification('Failed to generate PDF. Check console.', 'error'); }
                    finally { previewModal.style.display = 'none'; previewModal.style.opacity = ''; previewModal.style.position = ''; previewModal.style.top = ''; previewContentArea.innerHTML = ''; hideLoading(); }
                };
                const downloadMarkdown = () => {
                    if (typeof TurndownService === 'undefined') { showNotification('Markdown conversion library not loaded.', 'error'); console.error('TurndownService not found.'); return; }
                    if (!turndownService) turndownService = new TurndownService({ headingStyle: 'atx', bulletListMarker: '*' });
                    let markdownOutput = ''; const coverData = reportData.sectionsContent['cover-page'] || {}; const references = reportData.sectionsContent['references-section'] || [];
                    const visibleSections = reportData.sectionsOrder.filter(id => reportData.sectionsVisibility[id] !== false);
                    markdownOutput += '---\n'; Object.entries(coverData).forEach(([key, value]) => { if (value) markdownOutput += `${key.replace(/_/g, '-')}: "${value}"\n`; }); markdownOutput += '---\n\n';
                    visibleSections.forEach(sectionId => {
                        if (sectionId === 'cover-page' || sectionId === 'references-section') return;
                        const config = reportData.sectionsConfig[sectionId]; let content = reportData.sectionsContent[sectionId] || '';
                        if (config?.name) markdownOutput += `## ${config.name}\n\n`;
                        if (!isLikelyMarkdown(content)) {
                             try { content = turndownService.turndown(content); } catch (e) { console.error(`Error converting HTML to MD for section ${sectionId}:`, e); content = `\n${content}`; }
                        }
                        markdownOutput += content + '\n\n';
                    });
                    if (reportData.sectionsVisibility['references-section'] !== false && references.length > 0) {
                        markdownOutput += `## References\n\n`; references.sort((a, b) => (a.key || '').localeCompare(b.key || ''));
                        references.forEach(ref => {
                            markdownOutput += `*   **[${ref.key || 'No Key'}]** ${ref.authors || 'N/A'} (${ref.year || 'N/A'}). *${ref.title || 'N/A'}*.`;
                             switch (ref.type) {
                                case 'journal': markdownOutput += ` ${ref.source || ''}. ${ref.volume || ''}: ${ref.pages || ''}.`; break;
                                case 'book': markdownOutput += ` ${ref.source || ''}. ${ref.pages ? `pp. ${ref.pages}` : ''}.`; break;
                                case 'website': markdownOutput += ` Retrieved from [${ref.url || 'N/A'}](${ref.url || '#'}) ${ref.accessDate ? `(Accessed: ${formatDate(ref.accessDate)})` : ''}.`; break;
                                case 'other': markdownOutput += ` ${ref.details || ''}.`; break;
                            } markdownOutput += '\n';
                        }); markdownOutput += '\n';
                    }
                    try {
                        const blob = new Blob([markdownOutput], { type: 'text/markdown;charset=utf-8' }); const url = URL.createObjectURL(blob);
                        const link = document.createElement('a'); const filename = (coverData.report_title || 'academic-report').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.md';
                        link.href = url; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                        showNotification('Markdown file downloaded.', 'success');
                    } catch (error) { console.error("Error creating Markdown download:", error); showNotification("Failed to download Markdown file.", "error"); }
                };
                const downloadHTML = () => {
                    try {
                        const reportHtml = generateReportHTMLForPreview();
                        const fullHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${reportData.sectionsContent?.coverPage?.report_title || 'Academic Report'}</title><style>body { font-family: 'Times New Roman', Times, serif; line-height: 1.5; font-size: 12pt; margin: 0; padding: 0; background-color: #fff; color: #000; } .preview-content-area { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm 18mm; box-sizing: border-box; background-color: #fff; page-break-after: always; } .report-section { margin-bottom: 0.5cm; page-break-inside: avoid; } .cover-page { text-align: center; min-height: calc(297mm - 40mm); display: flex; flex-direction: column; justify-content: space-between; align-items: center; border: none; padding: 0; margin: -20mm -18mm; width: 210mm; } .cover-page-content { padding: 20mm 18mm; width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; justify-content: space-between; } .cover-page-top { margin-top: 1cm; } .cover-page-middle { margin: 3cm 0; } .cover-page-bottom { margin-bottom: 1cm; width: 80%; } .institution-logo { max-width: 120px; max-height: 100px; height: auto; margin-bottom: 1cm; } .report-title { font-size: 24pt; font-weight: bold; margin-bottom: 0.5cm; color: #000; border-bottom: none; } .report-subtitle { font-size: 18pt; margin-bottom: 2cm; color: #333; } .author-info { font-size: 12pt; line-height: 1.6; } .author-name { font-weight: bold; margin-bottom: 0.3cm; font-size: 14pt; } .submission-info { text-align: center; font-size: 11pt; color: #333; line-height: 1.5; } h1, h2, h3, h4 { font-family: 'Times New Roman', Times, serif; font-weight: bold; color: #000; margin-top: 1cm; margin-bottom: 0.5cm; line-height: 1.3; page-break-after: avoid; page-break-inside: avoid; } h1 { font-size: 20pt; text-align: center; } h2, .report-section-title { font-size: 16pt; border-bottom: 1px solid #aaa; padding-bottom: 0.2cm; margin-top: 1.5cm; margin-bottom: 0.7cm; } h3 { font-size: 14pt; } h4 { font-size: 12pt; font-style: italic; } p { margin-bottom: 0.4cm; text-align: justify; color: #000; } ul, ol { margin-left: 0.8cm; margin-bottom: 0.4cm; padding-left: 0.5cm; } li { margin-bottom: 0.2cm; } table.report-table { width: 100%; border-collapse: collapse; margin: 1cm auto; font-size: 10pt; border: 1px solid #888; page-break-inside: avoid; } table.report-table th, table.report-table td { border: 1px solid #aaa; padding: 0.25cm 0.35cm; text-align: left; vertical-align: top; } table.report-table th { background-color: #e8e8e8; font-weight: bold; color: #000; } img.report-image { max-width: 90%; height: auto; display: block; margin: 1cm auto; border: 1px solid #ccc; page-break-inside: avoid; } blockquote { border-left: 3px solid #ccc; padding-left: 1.5em; margin: 0.5cm 0; font-style: italic; color: #333; } a { color: #0000EE; text-decoration: underline; } .references-list-preview { list-style: none; padding-left: 0; } .references-list-preview li { margin-bottom: 0.3cm; } @media print { body { margin: 0; padding: 0; } .preview-content-area { width: auto; min-height: auto; margin: 0; padding: 0; box-shadow: none; border: none; page-break-after: auto; } .report-section { page-break-before: auto; } .cover-page { page-break-after: always; } }</style></head><body><div class="preview-content-area">${reportHtml}</div></body></html>`;
                        const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' }); const url = URL.createObjectURL(blob);
                        const link = document.createElement('a'); const filename = (reportData.sectionsContent?.coverPage?.report_title || 'academic-report').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.html';
                        link.href = url; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                        showNotification('HTML file downloaded.', 'success');
                    } catch (error) { console.error("Error creating HTML download:", error); showNotification("Failed to download HTML file.", "error"); }
                };
                const init = () => {
                    showLoading('Initializing Report Creator...');
                    loadData(); 
                    applyTheme();
                    applyFocusMode();
                    updateTemplateCardSelection();
                    if (window.marked) {
                        marked.setOptions({ breaks: true, gfm: true });
                    } else { console.warn("Marked library not loaded."); }
                    if (window.TurndownService) {
                        turndownService = new TurndownService({ headingStyle: 'atx', bulletListMarker: '*' });
                    } else { console.warn("Turndown library not loaded."); }
                    renderSections();
                    renderReferences();
                    renderVersionHistory();
                    const initialSection = reportData.sectionsOrder.includes(activeSectionId) ? activeSectionId : (reportData.sectionsOrder[0] || 'cover-page');
                    updateEditorModeView();
                    toggleEditorModeBtn.querySelector('.mode-indicator').textContent = `(${(editorMode === 'tinymce' ? 'Rich Text' : 'Markdown')})`;
                    setActiveSection(initialSection); 
                    themeToggleBtn.addEventListener('click', toggleTheme);
                    focusToggleBtn.addEventListener('click', toggleFocusMode);
                    clearStorageBtn.addEventListener('click', clearData);
                    templateCards.forEach(card => {
                        card.addEventListener('click', () => applyTemplate(card.dataset.template));
                        card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') applyTemplate(card.dataset.template); });
                    });
                    addSectionBtn.addEventListener('click', () => showModal(addSectionModal));
                    confirmAddSectionBtn.addEventListener('click', addSection);
                    cancelAddSectionBtn.addEventListener('click', () => hideModal(addSectionModal));
                    addSectionModal.addEventListener('click', (e) => { if (e.target === addSectionModal) hideModal(addSectionModal); });
                    saveVersionBtn.addEventListener('click', saveVersion);
                    confirmRestoreVersionBtn.addEventListener('click', restoreVersion);
                    cancelRestoreVersionBtn.addEventListener('click', () => { hideModal(restoreVersionModal); versionToRestore = null; });
                    restoreVersionModal.addEventListener('click', (e) => { if (e.target === restoreVersionModal) { hideModal(restoreVersionModal); versionToRestore = null; } });
                    tabButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const targetTab = button.dataset.tab;
                             if ((activeSectionId === 'cover-page' && targetTab === 'form') ||
                                (activeSectionId === 'references-section' && targetTab === 'references') ||
                                (activeSectionId !== 'cover-page' && activeSectionId !== 'references-section' && targetTab === 'editor'))
                             { switchTab(targetTab); }
                        });
                    });
                    coverPageForm.addEventListener('input', saveCoverPageData);
                    saveSectionBtn.addEventListener('click', () => saveCurrentSectionContent(true));
                    toggleEditorModeBtn.addEventListener('click', toggleEditorMode);
                    markdownEditor.addEventListener('input', () => {
                        updateMarkdownPreview(); updateWordCount(); updateSaveStatus('unsaved');
                        debounce(saveCurrentSectionContent, 1500);
                    });
                    refTypeSelect.addEventListener('change', updateRefFormFields);
                    addReferenceBtn.addEventListener('click', addReference);
                    updateReferenceBtn.addEventListener('click', updateReference);
                    cancelEditReferenceBtn.addEventListener('click', clearRefForm);
                    updateRefFormFields();
                    previewBtn.addEventListener('click', showPreview);
                    previewCloseBtn.addEventListener('click', () => hideModal(previewModal));
                    previewModal.addEventListener('click', (e) => { if (e.target === previewModal) hideModal(previewModal); });
                    downloadPdfBtn.addEventListener('click', downloadPDF);
                    downloadMdBtn.addEventListener('click', downloadMarkdown);
                    downloadHtmlBtn.addEventListener('click', downloadHTML);
                    updateSaveStatus('saved'); 
                    hideLoading();
                    showNotification('Report Creator Ready!', 'success', 2000);
                };
                init();
            });
        </script>
    </body>
</html>